"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[791],{8466:(T,A,c)=>{c.d(A,{n:()=>L});var y=c(6339),E=c(6789);let L=(()=>{class u{constructor(e){this.sharedvar=e,this.groupRefTrue=[]}parsePollList(e,i){for(let o=0;o<i.length;o++){const m=i[o];e.pollList.push(this.newPoll(m.name));const _=e.pollList[e.pollList.length-1].schema;for(let b=1;b<m.data.length;b++)_.controls.push(this.data2control(m.data[b]))}return i}data2control(e){const i=this.sharedvar.getUniqueName("",e.A,this.sharedvar.pollGrpExecuted.pollList),o=this.getTypeFromData(e.B),m=this.getEvidenceFromData(e.E),_={dtbase:e.F,type:o,evidence:m,help:e.H},b={required:e.D};let C=[];o.includes("select")&&e.C.split(";").forEach(t=>{const s=t.split(":");C.push({key:s[0],value:s[1]})});const f={name:i,label:e.A,type:o,style:this.getStyleFromData(e.G),tags:_,selectOptions:C,validators:b};return this.getSideBtn(f),f}getTypeFromData(e){switch(e){case"Agenda":return"appoint";case"Area de Texto":return"textarea";case"Texto":return"text";case"Contrase\xf1a":return"password";case"CRM Clientes":return"costumer";case"CRM Clientes (Editable)":return"costumer_edit";case"CRM Productos":return"product";case"Dibujo":return"draw";case"Duplicar Grupo":return"duplicate";case"Fecha":return"date";case"Fecha-Hora":return"datetime-local";case"Foto":return"picture";case"Geolocalizaci\xf3n":return"geolocation";case"Ir a...":return"goto";case"N\xfamero":return"number";case"Selecci\xf3n":return"select";case"Selecci\xf3n Multiple":return"multiselect";case"Caja de verificaci\xf3n":return"checkbox";case"T\xedtulo":return"header";default:return""}}getStyleFromData(e){return e&&0!==e.length?e.split(",").map(i=>i.trim()):["w-full"]}getEvidenceFromData(e){let i=[];if(0===e.length)return i;const o=e.split(",");return o.includes("Sin evidencia")||o.forEach(m=>{switch(m.trim()){case"Nota":i.push("note");break;case"Foto":i.push("picture");break;case"Firma":i.push("draw");break;case"Adjunto":i.push("attach")}}),i}getSideBtn(e){switch(e.type){case"appoint":e.type="text",e.sideBtn="pending_actions",e.disabled=!0;break;case"costumer":case"costumer_edit":e.type="text",e.sideBtn="people",e.disabled=!0;break;case"geolocation":e.type="text",e.sideBtn="terrain",e.disabled=!0;break;case"header":e.default=e.label,e.disabled=!0;break;case"goto":e.type="select",e.sideBtn="east";break;case"draw":e.type="text",e.sideBtn="edit",e.disabled=!0;break;case"picture":e.type="text",e.sideBtn="photo_camera",e.disabled=!0;break;case"product":e.type="text",e.sideBtn="shopping_cart",e.disabled=!0;break;case"duplicate":e.type="select",e.sideBtn="add",e.sideBtn2="navigate_next",e.tags.dupactivity=e.dupactivity||"";break;case"textarea":case"text":e.sideBtn="mic_none"}return e}getUniqueTitle(e,i){let o=0,m="";const _=i.split(" ");let b=Number(_[_.length-1]);""!=_[_.length-1]&&!isNaN(b)&&(_.splice(_.length-1,1),i=_.join(" "));for(let C=0;C<this.sharedvar.pollGrpExecuted.pollList.length;C++){const f=this.sharedvar.pollGrpExecuted.pollList[C].schema.controls||[];for(let D=0;D<f.length;D++)if(f[D].label.toUpperCase().includes(`${i}${m}`.toUpperCase())&&f[D].name!==e){m="_"+o++,C=-1;break}}return`${i}${m}`}getGroupRef(){return this.groupRefTrue=[],this.getRefNodeTrue(this.sharedvar.pollGroupIndex),this.groupRefTrue}getRefNodeTrue(e){if(e.children)for(let i=0;i<e.children.length;i++){const o=e.children[i];if(o.ref)this.groupRefTrue.push({key:o.id,value:o.model_name||o.name});else if(o.children&&o.children.length>0)return this.getRefNodeTrue(o)}}newPoll(e="Actividad"){return{id:this.sharedvar.getSerialKey(3,4,"_"),title:e,allowStart:!1,allowEnd:!1,duplicated:!1,totalDup:0,dupTotal:0,schema:{controls:[]},values:{_valid_:!0}}}static#e=this.\u0275fac=function(i){return new(i||u)(y.LFG(E.D))};static#t=this.\u0275prov=y.Yz7({token:u,factory:u.\u0275fac,providedIn:"root"})}return u})()},1791:(T,A,c)=>{c.d(A,{x:()=>C});var y=c(3241),E=c(8661),L=c(3420),u=c(6339),M=c(6789),e=c(3016),i=c(7254),o=c(3792),m=c(1781),_=c(2615),b=c(8466);let C=(()=>{class f{constructor(t,s,n,a,g,r,v){this.sharedvar=t,this.dtb=s,this.snkBar=n,this.dg=a,this.ds=g,this.notif=r,this.pollServ=v,this.schemaAppoint={controls:[{name:"staff",label:"Responsable:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"pollgrp_id",label:"Tarea a ejecutar:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"datetime",label:"Fecha y hora:",type:"datetime-local",validators:{required:!0}},{name:"dateend",label:"Fecha y hora final sugerida:",type:"datetime-local",sideBtn:"more_time",validators:{required:!0}},{name:"sche_schedule",label:"Reagendar:",type:"select",style:"ml-4",selectOptions:[{key:"n",value:"Nunca"},{key:"d",value:"Diario"},{key:"s",value:"Semanal"},{key:"m",value:"Mensual"},{key:"o",value:"Otra frecuencia"}],default:"n",validators:{required:!0}},{name:"sche_other",label:"Frecuencia (d\xedas):",type:"number",style:"ml-4",default:0,validators:{}},{name:"notifMailList",label:"Lista de correo para notificar fallas:",type:"textarea",totalRows:4,style:"ml-4 w-full",validators:{}},{name:"notes",label:"Notas:",type:"textarea",totalRows:4,style:"w-full",validators:{}},{name:"crm_costum_name",label:"Cliente",type:"text",sideBtn:"people",style:"w-full",disabled:!0,validators:{}},{name:"contact",label:"Contacto",type:"text",style:"w-full",validators:{}},{name:"address",label:"Direcci\xf3n",type:"text",style:"w-full",validators:{}},{name:"geoLoc",label:"Geolocalizaci\xf3n",type:"text",style:"w-full",sideBtn:"room",disabled:!0,validators:{}}]},this.messageSchema={controls:[{name:"message",label:"Mensaje:",type:"textarea",totalRows:4,style:"w-full",validators:{required:!0}}]},this.groupRefTrue=[],this.taskerData={picture:{title:"Foto",type:"blob-picture"},active:{title:"Activo",type:"boolean"},id:{title:"Identificaci\xf3n",type:"string"},names:{title:"Nombres",type:"string"},lastnames:{title:"Apellidos",type:"string"},age:{title:"Edad",type:"number"},address:{title:"Direcci\xf3n",type:"string"},city:{title:"Ciudad",type:"string"},email:{title:"Correo",type:"string"},phone:{title:"Tel\xe9fono",type:"string"},platform:{title:"Plataform pago",type:"string"},platform_phone:{title:"Tel\xe9fono plataforma",type:"string"},legal_age:{title:"Edad legal",type:"boolean"},stars:{title:"Estrellas",type:"number"},studyLevel:{title:"Nivel de estudio",type:"number"}}}startAppointData(t){if(this.staffList=t,this.groupRefTrue=this.pollServ.getGroupRef(),this.schemaAppoint.controls){const s=this.schemaAppoint.controls.find(a=>"pollgrp_id"===a.name);s&&(s.selectOptions=this.groupRefTrue);const n=this.schemaAppoint.controls.find(a=>"staff"===a.name);n&&(n.selectOptions=[],t.forEach(a=>{a._id&&n.selectOptions?.push({key:a._id,value:`${a.names} ${a.lastnames||""}`})}))}}getPollGrpName(t){if(t){const s=this.groupRefTrue.find(n=>n.key===t);if(s)return s.value}return""}onDelAppoint(t,s){!t.appoint||0===t.appoint.length||this.snkBar.open("Eliminar item de la agenda?.","Ok",{duration:5e3}).onAction().subscribe(n=>{t.appoint?.splice(s,1),this.dtb.updateStaffAsync(t)})}onAddEditAppoint(t,s,n=!0){var a=this;return(0,y.Z)(function*(){let g,r,v="Agenda ";const h=null===t||-1===s;if(null==t&&(t=a.staffList[0]),t.appoint||(t.appoint=[]),r=-1===s?a.appointBasic(t,"appoint"):t.appoint[s],v+=h?"Nueva":`${t.names} ${t.lastnames||""}`,a.schemaAppoint.controls){let l=-1;l=a.schemaAppoint.controls.findIndex(k=>"contact"===k.name),l>=0&&(a.schemaAppoint.controls[l].type="text"),l=a.schemaAppoint.controls.findIndex(k=>"staff"===k.name),a.schemaAppoint.controls[l].disabled=!h,l=a.schemaAppoint.controls.findIndex(k=>"geoLoc"===k.name),l>=0&&(a.schemaAppoint.controls[l].sideBtn=n?"room":"")}t.appoint&&r&&(g={staff:t._id,...r});let d={schema:a.schemaAppoint,title:v,value:g,dgwidth:400,function:[{name:"crm_costum_name",self:a,btn_source:1,function:a.getCostumer1},{name:"datetime",self:a,btn_source:0,function:a.updateEndTime},{name:"dateend",self:a,btn_source:1,function:a.addTime},{name:"geoLoc",self:a,btn_source:1,function:a.geolocation}]};const p=yield a.dg.aDefault(d);if(p){const l=a.staffList.find(B=>B._id==p.staff);if(!l)return;l.appoint||(l.appoint=[]),p.dateend<=p.datetime&&(p.dateend=p.datetime+a.sharedvar.addMinutes(15)),p.staff_name=`${l.names} ${l.lastnames}`,delete p._btnEvent_,delete p._btnclick_,delete p._propName_,delete p._valid_,delete p.staff,a.dg.updatePropResult(r,p),a.selectedCostumer&&(r.contact===a.selectedCostumer.linkup_1?(r.email=a.selectedCostumer.email_1,r.phone=a.selectedCostumer.phone_1):(r.email=a.selectedCostumer.email_2,r.phone=a.selectedCostumer.phone_2),r.defa_values={crm_costum_id:a.selectedCostumer.id,crm_costum_name:a.selectedCostumer.name,crm_costum_contact:r.contact,crm_costum_email:r.email,crm_costum_phone:r.phone,crm_note:r.notes}),r.pollgrp_model_name=a.getPollGrpName(p.pollgrp_id),r.reported=!1,r.ended=!1,h?l.appoint.push(r):l.appoint[s]=r,a.dtb.updateStaffAsync(l);const k=`<h3>Agenda: ${r.pollgrp_model_name}</h3>\n          <p><strong>Fecha:</strong> ${a.sharedvar.formatNumber2DateTime(r.datetime,"/")}</p>\n          <p><strong>Cliente:</strong> ${r.crm_costum_name||"No aplica"}</p>\n          <p><strong>Notas:</strong> ${r.notes||"Ninguna"}</p>\n        `;a.dtb.otherNotification({to:l.email||"",subject:"Agenda",html:k,data:{}});const O=`Agenda ->${a.sharedvar.formatNumber2DateTime(r.datetime,"/")} Formulario: ${r.pollgrp_model_name} notas: ${r.notes}`;a.notif.sendCommand({cmd:"appoint",user_id:a.sharedvar.staff._id,usert_id:l._id,data:O})}})()}onMessage2(t,s){var n=this;return(0,y.Z)(function*(){let r={schema:n.messageSchema,title:"Mensaje a "+t||0,dgwidth:400,dgheigth:300};const v=yield n.dg.aDefault(r);v&&n.notif.sendCommand({cmd:"message",user_id:n.sharedvar.staff._id,usert_id:s,data:{msg:{msg:v.message,who:n.sharedvar.staff.names||""},pollGrpName:n.sharedvar.staff.names||""}})})()}getCostumer1(t,s,n){return(0,y.Z)(function*(){if(!s)return;const a=[],g=yield t.dtb.getActiveCRMCostumAsync();if(!g)return;g.forEach(h=>{h&&a.push({selected:!1,myid:h.id,name:h.name})});const r={title:"Seleccione Cliente",dgheigth:450,viewfilter:!0,viewAdd:!0,multiSelect:!1,valuelst:a},v=yield(0,E.z)(t.ds.aSelectDefault(r));if(v){if(!0===v.new){const d=yield t.newCostumer(t,"owner");if(!d)return{schema:n,value:s};t.selectedCostumer=d}else t.selectedCostumer=g.find(d=>d.name===v[0].name);s.crm_costum_name=t.selectedCostumer.name,s.crm_costum_mail=t.selectedCostumer.email,s.address=t.selectedCostumer.address;const h=n.controls?.findIndex(d=>"contact"===d.name);if(h&&h>=0&&n.controls){const d=[];t.selectedCostumer?.linkup_1&&d.push({key:t.selectedCostumer.linkup_1,value:t.selectedCostumer.linkup_1}),t.selectedCostumer?.linkup_2&&d.push({key:t.selectedCostumer?.linkup_2,value:t.selectedCostumer?.linkup_2}),n.controls[h].type="select",n.controls[h].selectOptions=d}}return{schema:n,value:s}})()}newCostumer(t,s){return(0,y.Z)(function*(){let n={schema:L.Cn,title:"Datos del cliente",dgwidth:550,dgheigth:715};const a=yield(0,E.z)(t.dg.aDefault(n));return a?(delete a._valid_,delete a._btnEvent_,delete a._propName_,a.ownertype=[s],a.active=!0,yield t.dtb.createCostumAsync(a)):null})()}updateEndTime(t,s,n){return(0,y.Z)(function*(){if(s)return s.dateend=Number(s.datetime)+t.sharedvar.addMinutes(15),{schema:null,value:s}})()}addTime(t,s,n){return(0,y.Z)(function*(){if(s)return s.dateend=Number(s.dateend)+t.sharedvar.addMinutes(15),{schema:null,value:s}})()}geolocation(t,s,n){return(0,y.Z)(function*(){if(!s)return;(!s.geoLoc||0===s.geoLoc.length)&&(s.geoLoc=yield t.sharedvar.getLocalization());const g={title:"Geo localizaci\xf3n",dgheigth:600,value:[t.staff2analitic(0,s,s)]},r=yield(0,E.z)(t.dg.aMap(g));return r&&(s.geoLoc=r.geoLocStart),{schema:null,value:s}})()}onFilter(t){}staff2analitic(t,s,n){return{_id:`${s._id}:${t}`,date_ini:n.datetime,date_end:n.dateend,geoLocStart:n.geoLoc,tasker_id:s._id||"",tasker_name:s.names+" "+(s.lastnames||""),activity_id:n.pollgrp_id||"",activity_name:n.pollgrp_model_name||"No asignada",costumer_name:n.crm_costum_name||"",crm_products:[],ended:!1}}appointBasic(t,s){return{type:s,datetime:this.sharedvar.dateNow(),dateend:this.sharedvar.dateNow(),ended:!1,reported:!1,owner:this.sharedvar.staff._id||"",staff_name:`${t.names||""} ${t.lastnames||""}`,email:t.email}}static#e=this.\u0275fac=function(s){return new(s||f)(u.LFG(M.D),u.LFG(e.k),u.LFG(i.ux),u.LFG(o.x),u.LFG(m.n),u.LFG(_.$),u.LFG(b.n))};static#t=this.\u0275prov=u.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})()}}]);