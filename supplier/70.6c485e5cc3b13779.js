"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[70],{1430:(at,b,u)=>{u.r(b),u.d(b,{TaskReportModule:()=>W});var _=u(7087),k=u(3759),m=u(3241),t=u(2283),M=u(4758),F=u(6806),x=u(5330),S=u(1682),C=u(1359),U=u(8035),N=u(3578),T=u(9347),Z=u(8464),L=u(9554),y=u(3279);const J=["chart"];function w(s,g){if(1&s&&(t.TgZ(0,"div",1),t._UZ(1,"apx-chart",2),t.qZA()),2&s){const a=t.oxw();t.xp6(1),t.Q6J("series",a.chartOptions.series)("chart",a.chartOptions.chart)("dataLabels",a.chartOptions.dataLabels)("plotOptions",a.chartOptions.plotOptions)("responsive",a.chartOptions.responsive)("xaxis",a.chartOptions.xaxis)("legend",a.chartOptions.legend)("fill",a.chartOptions.fill)}}let A=(()=>{class s{constructor(){this.data=[],this.prod_list=[],this.pivot=0,this.bartype=0,this.chunk="M",this.onSelect=new t.vpe,this.sliceChunk=[]}ngOnChanges(a){this.data&&this.data.length>0&&(this.setChunkList(),this.buildChart())}buildChart(){var a=this;return(0,m.Z)(function*(){switch(a.pivot){case 0:a.getDataTaskCostumerChunk(a.sliceChunk,"T");break;case 1:a.getDataTaskCostumerChunk(a.sliceChunk,"A");break;case 2:a.getDataTaskCostumerChunk(a.sliceChunk,"C");break;case 3:a.timeLineProductPivot(a.sliceChunk)}a.chartOptions={series:a.serieList,chart:{type:"bar",height:350,stacked:!0,stackType:"100%",toolbar:{show:!0,tools:{pan:!0,zoomin:!0,zoomout:!0}}},responsive:[{breakpoint:480,options:{legend:{position:"bottom",offsetX:-10,offsetY:0}}}],xaxis:{categories:a.categ},fill:{opacity:1},legend:{position:"top",horizontalAlign:"left",offsetX:0,offsetY:10}}})()}setChunkList(){let a=this.getChunkSlice(this.data[0].date_ini).firstDay;const i=this.getChunkSlice(this.data[this.data.length-1].date_end).lastDay;for(this.sliceChunk=[];a<i;)this.sliceChunk.push(this.getChunkSlice(a)),a=this.getChunkNextDate(this.sliceChunk[this.sliceChunk.length-1].lastDay)}getChunkSlice(a){let i;const e=new Date(a);switch(this.chunk){case"D":const n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0).getTime(),o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23).getTime();return i=`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`,{firstDay:n,lastDay:o,name:i};case"M":const l=new Date(e.getFullYear(),e.getMonth(),1,0).getTime(),r=new Date(e.getFullYear(),e.getMonth()+1,0,23).getTime();return i=`${e.getMonth()+1}/${e.getFullYear()}`,{firstDay:l,lastDay:r,name:i};case"Y":const c=e.getFullYear();return i=c.toString(),{firstDay:new Date(c,0,1,0).getTime(),lastDay:new Date(c,11,31,23).getTime(),name:i}}return{firstDay:0,lastDay:0,name:"ni idea"}}getChunkNextDate(a){const i=new Date(a);switch(this.chunk){case"D":return new Date(i.getFullYear(),i.getMonth(),i.getDate()+1,0).getTime();case"M":return new Date(i.getFullYear(),i.getMonth()+1,i.getDate(),0).getTime();case"Y":return new Date(i.getFullYear()+1,0,1,0).getTime()}return 0}getDataTaskCostumerChunk(a,i){let e=[];this.serieList=[];let n=[];this.data.forEach(c=>{let p="";switch(i){case"T":p=c.tasker_name;break;case"A":p=c.activity_name;break;case"C":p=c.costumer_name}e.push(p)}),e=[...new Set(e)],e.forEach(c=>{c&&(n.push({key:c,value:0}),this.serieList.push({name:c,data:[]}))}),e=[],this.categ=[],n.forEach(c=>c.value=0);let r,o=0,l=0;for(;l<this.data.length;){if(!(o<a.length))return;for(r=a[o],this.categ.push(r.name),o++;l<this.data.length&&this.data[l].date_ini>=r.firstDay&&this.data[l].date_end<=r.lastDay;l++){const c=n.find(p=>{switch(i){case"T":return p.key===this.data[l].tasker_name;case"A":return p.key===this.data[l].activity_name;case"C":return p.key===this.data[l].costumer_name}return null});c&&c.value++}this.serieList.forEach(c=>{const p=n.find(v=>v.key===c.name);p&&c.data.push(p.value)})}}timeLineProductPivot(a){(!this.prod_list||0===this.prod_list.length)&&(this.prod_list=[],this.data.forEach(r=>{r.crm_products&&r.crm_products.length>0&&this.prod_list.push(...r.crm_products)}));let i=[...new Set(this.prod_list)];this.serieList=[];let e=[];i.forEach(r=>{r&&(e.push({key:r,value:0}),this.serieList.push({name:r,data:[]}))}),i=[],this.categ=[];let l,n=0,o=0;for(e.forEach(r=>r.value=0);o<this.data.length;){if(!(n<a.length))return;for(l=a[n],this.categ.push(l.name),n++;o<this.data.length&&this.data[o].date_ini>=l.firstDay&&this.data[o].date_end<=l.lastDay;o++)e.forEach(r=>{this.data[o].crm_products.find(p=>p===r.key)&&r.value++});this.serieList.forEach(r=>{const c=e.find(p=>p.key===r.name);c&&r.data.push(c.value)})}}static#t=this.\u0275fac=function(i){return new(i||s)};static#e=this.\u0275cmp=t.Xpm({type:s,selectors:[["app-stack-col-ptj"]],viewQuery:function(i,e){if(1&i&&t.Gf(J,5),2&i){let n;t.iGM(n=t.CRH())&&(e.chart=n.first)}},inputs:{data:"data",prod_list:"prod_list",pivot:"pivot",bartype:"bartype",chunk:"chunk"},outputs:{onSelect:"onSelect"},features:[t.TTD],decls:1,vars:1,consts:[["id","chart",4,"ngIf"],["id","chart"],[3,"series","chart","dataLabels","plotOptions","responsive","xaxis","legend","fill"]],template:function(i,e){1&i&&t.YNc(0,w,2,8,"div",0),2&i&&t.Q6J("ngIf",e.data&&e.data.length>0)},dependencies:[_.O5,y.x]})}return s})();const Y=["editControlTrigger"],P=["chartTrigger"];function O(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function q(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function E(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function G(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function I(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function Q(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function j(s,g){1&s&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}const B=[{path:"",component:(()=>{class s{constructor(a,i,e,n,o,l){this.sharedvar=a,this.dtb=i,this.dg=e,this.data2excel=n,this.snkBar=o,this.notif=l,this.pivot=0,this.bartype=1,this.chunk="D",this.graphtypeName="Linea de tiempo apilado",this.mpos={x:-1,y:-1}}ngOnInit(){var a=this;return(0,m.Z)(function*(){const i=new Date,e=i.setHours(0,0,0,0),n=i.setHours(23,59,59,999);a.localFilter={crm:"T",staff__id:[],pollGrpData:[],costumers:[],products:[],products_name_sel:[],date_ini:e,date_end:n},yield a.executeFilter(),a.resultSub=a.notif.getResultNotif_Obs().subscribe({next:o=>{(a.dataList.find(r=>r._id===o.field_id)||"delete"===o.dbState||"update"===o.dbState)&&a.snkBar.open("Hay novedades en el informe. Desea actualizar la vista","Si",{duration:5e3}).onAction().subscribe(r=>{a.executeFilter()})}})})()}ngOnDestroy(){this.resultSub&&this.resultSub.unsubscribe()}executeFilter(){var a=this;return(0,m.Z)(function*(){yield a.dtb.getPollGrpAnaliticAsync(a.localFilter).then(i=>{a.dataList=i.data,a.header=i.header})})()}getClicked(a){var i=this;return(0,m.Z)(function*(){switch(a.index){case 1:i.filterDialog();break;case 3:let e=document.getElementById("spanTrigger");e&&(e.style.display="",e.style.position="absolute",e.style.left=a.pageX+5+"px",e.style.top=a.pageY+5+"px",i.editControlTrigger.openMenu());break;case 4:yield i.executeFilter()}})()}getTitleText(){return`${this.graphtypeName} - ${this.getPivotName()} - Porcentaje por ${this.getTimechunk()} ... Fecha desde: ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"/")}\n    hasta: ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"/")}`}filterDialog(){var a=this;return(0,m.Z)(function*(){a.sharedvar.wait=!0;let i=[],e=[],n=[],o=[];(yield a.dtb.getStaffByFilterAsync({queryType:3,active:!0,stars:0,rol:"K"})).forEach(h=>{i.push({key:h._id,value:`${h.names||h.email} ${h.lastnames||""}`})}),(yield a.dtb.getPollGrpActiveAsync()).forEach(h=>{"index"!==h.id&&e.push({key:h._id,value:h.name})}),(yield a.dtb.getActiveCRMCostumAsync()).forEach(h=>{n.push({key:h.id,value:h.name})}),(yield a.dtb.getAllCRMProdAsync()).forEach(h=>{o.push({key:h.id,value:h.name})}),a.dg.aDefault({schema:{controls:[{name:"staff__id",label:"Taskers:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:i},{name:"pollGrpData",label:"Modelos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:e},{name:"costumers",label:"Clientes:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:n},{name:"products",label:"Productos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:o},{name:"date_ini",label:"Fecha inicio:",type:"date",validators:{}},{name:"date_end",label:"Fecha final:",type:"date",validators:{}}]},title:"Filtros",dgheigth:615,dgwidth:550,value:a.localFilter}).subscribe(function(){var h=(0,m.Z)(function*(d){if(a.sharedvar.wait=!1,d){if(d.alldates)d.date_ini=0,d.date_end=0;else{let f=new Date(d.date_ini||0);d.date_ini=f.setHours(0,0,0,0),f=new Date(d.date_end||0),d.date_end=f.setHours(23,59,59,999)}const D=[];d.products&&d.products.length>0&&d.products.forEach(f=>{const R=o.find(et=>et.key===f);R&&D.push(R.value)}),a.localFilter={crm:"T",staff__id:d.staff__id,pollGrpData:d.pollGrpData,costumers:d.costumers,products:d.products,date_ini:d.date_ini,date_end:d.date_end,products_name_sel:[...D]},yield a.executeFilter()}});return function(d){return h.apply(this,arguments)}}())})()}mousepos(a){this.mpos.x=a.clientX,this.mpos.y=a.clientY}onSelect(a){var i=this;return(0,m.Z)(function*(){let e=document.getElementById("chartTrigger");e&&(i.graphevent=a,e.style.display="",e.style.position="absolute",e.style.left=i.mpos.x+5+"px",e.style.top=i.mpos.y+5+"px",i.chartTrigger.openMenu())})()}getGraphInfo(a){var i=this;return(0,m.Z)(function*(){const e=yield i.dtb.getPollResultAsync(i.graphevent.meta);switch(a){case 0:2===e.status&&i.snkBar.open("La encuesta est\xe1 en proceso, los datos pueden no estar actualizados","Ok",{duration:3e3});let n={schema:{},value:e,title:"Datos de la encuesta"};yield i.dg.aPollResult(n).subscribe(r=>{});break;case 1:break;case 2:i.notif.sendCommand({cmd:"geoloc",user_id:i.sharedvar.staff._id,usert_id:e.staff__id});break;case 3:if(e.status>2)return void i.snkBar.open("Ya finaliz\xf3 la encuesta","Ok",{duration:3e3});i.dg.aChat({title:"Chat",dgwidth:400,value:e||[]}).subscribe(r=>{r.notification&&r.notification.value.length>0&&(e.chats=r.notification.value,i.dtb.updatePollResultAsync(e))})}})()}onExportexcel(){const a=`Reporte CRM fechas ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"-")} - \n    ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"-")}`;this.data2excel.excelExport(this.dataList,a,"CRM",this.header,[])}onSelPivot(a){this.pivot=a}getPivotName(){switch(this.pivot){case 0:return"Tasker";case 1:return"Actividades";case 2:return"Clientes";case 3:return"Productos"}return""}setGraphType(a){switch(this.bartype=a,a){case 0:this.graphtypeName="Linea de tiempo discriminado";break;case 1:this.graphtypeName="Linea de tiempo apilado";break;case 2:this.graphtypeName="Barra de porcentaje"}}setTimechunk(a){this.chunk=a}getTimechunk(){switch(this.chunk){case"D":return"d\xedas";case"M":return"meses";case"Y":return"a\xf1os"}return""}static#t=this.\u0275fac=function(i){return new(i||s)(t.Y36(M.D),t.Y36(F.k),t.Y36(x.x),t.Y36(S.Z),t.Y36(C.ux),t.Y36(U.$))};static#e=this.\u0275cmp=t.Xpm({type:s,selectors:[["app-task-report"]],viewQuery:function(i,e){if(1&i&&(t.Gf(Y,5),t.Gf(P,5)),2&i){let n;t.iGM(n=t.CRH())&&(e.editControlTrigger=n.first),t.iGM(n=t.CRH())&&(e.chartTrigger=n.first)}},decls:87,vars:23,consts:[[1,"flex","flex-col","max-h-screen"],[3,"buttons","nav_menu","bar_text","onClicked"],["id","spanTrigger",3,"matMenuTriggerFor"],["editControlTrigger","matMenuTrigger"],[1,"flex-1","m-2","bg-gray-100","overflow-scroll",3,"mousemove"],[1,"border","border-gray-200","rounded-sm","shadow-lg"],[3,"data","prod_list","pivot","bartype","onSelect"],[3,"data","prod_list","pivot","bartype","chunk","onSelect"],["id","chartTrigger",3,"matMenuTriggerFor"],["chartTrigger","matMenuTrigger"],["controlEdit","matMenu"],["mat-menu-item","",3,"matMenuTriggerFor"],["color","primary"],[1,"mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-3"],["mat-menu-item","",3,"click"],[4,"ngIf"],["mat-menu-item",""],[1,"ml-1","mt-1","text-violet-500","text-lg","font-medium"],["graphtype","matMenu"],["graphMenu","matMenu"]],template:function(i,e){if(1&i&&(t.TgZ(0,"div",0)(1,"app-header",1),t.NdJ("onClicked",function(o){return e.getClicked(o)}),t.qZA(),t._UZ(2,"span",2,3),t.TgZ(4,"div",4),t.NdJ("mousemove",function(o){return e.mousepos(o)}),t.TgZ(5,"div",5)(6,"app-time-line",6),t.NdJ("onSelect",function(o){return e.onSelect(o)}),t.qZA()(),t.TgZ(7,"div",5)(8,"app-stack-col-ptj",7),t.NdJ("onSelect",function(o){return e.onSelect(o)}),t.qZA()(),t._UZ(9,"span",8,9),t.qZA()(),t.TgZ(11,"mat-menu",null,10)(13,"button",11)(14,"mat-icon",12),t._uU(15,"trending_up"),t.qZA(),t.TgZ(16,"span",13),t._uU(17),t.qZA()(),t.TgZ(18,"div",14)(19,"button",15),t.NdJ("click",function(){return e.onSelPivot(0)}),t.YNc(20,O,2,0,"mat-icon",16),t._uU(21," Tasker "),t.qZA(),t.TgZ(22,"button",15),t.NdJ("click",function(){return e.onSelPivot(1)}),t.YNc(23,q,2,0,"mat-icon",16),t._uU(24," Actividad "),t.qZA(),t.TgZ(25,"button",15),t.NdJ("click",function(){return e.onSelPivot(2)}),t.YNc(26,E,2,0,"mat-icon",16),t._uU(27," Cliente "),t.qZA(),t.TgZ(28,"button",15),t.NdJ("click",function(){return e.onSelPivot(3)}),t.YNc(29,G,2,0,"mat-icon",16),t._uU(30," Producto "),t.qZA()(),t._UZ(31,"hr"),t.TgZ(32,"h2",13)(33,"mat-icon"),t._uU(34,"percent"),t.qZA(),t._uU(35,"\xa0Porcentajes por:"),t.qZA(),t.TgZ(36,"button",15),t.NdJ("click",function(){return e.setTimechunk("D")}),t.YNc(37,I,2,0,"mat-icon",16),t._uU(38," D\xedas "),t.qZA(),t.TgZ(39,"button",15),t.NdJ("click",function(){return e.setTimechunk("M")}),t.YNc(40,Q,2,0,"mat-icon",16),t._uU(41," Meses "),t.qZA(),t.TgZ(42,"button",15),t.NdJ("click",function(){return e.setTimechunk("Y")}),t.YNc(43,j,2,0,"mat-icon",16),t._uU(44," A\xf1os "),t.qZA(),t._UZ(45,"hr"),t.TgZ(46,"h2",13)(47,"mat-icon"),t._uU(48,"trending_up"),t.qZA(),t._uU(49,"\xa0Inteligencia Artificial "),t.qZA(),t.TgZ(50,"div")(51,"button",17),t._uU(52," An\xe1lisis con soporte de IA "),t.qZA()(),t._UZ(53,"hr"),t.TgZ(54,"h2",18)(55,"mat-icon"),t._uU(56,"file_download"),t.qZA(),t._uU(57,"\xa0Exportar"),t.qZA(),t.TgZ(58,"div",14)(59,"button",15),t.NdJ("click",function(){return e.onExportexcel()}),t._uU(60," Exportar Informe a Excel. "),t.qZA(),t.TgZ(61,"button",17),t._uU(62," Enviar Informe a Google Spread Sheet "),t.qZA()()(),t.TgZ(63,"mat-menu",null,19)(65,"button",15),t.NdJ("click",function(){return e.setGraphType(0)}),t._uU(66," Linea de tiempo discriminado "),t.qZA(),t.TgZ(67,"button",15),t.NdJ("click",function(){return e.setGraphType(1)}),t._uU(68," Linea de tiempo apilado "),t.qZA()(),t.TgZ(69,"mat-menu",null,20)(71,"button",15),t.NdJ("click",function(){return e.getGraphInfo(0)}),t.TgZ(72,"mat-icon"),t._uU(73,"task_alt"),t.qZA(),t._uU(74," Datos de la encuesta "),t.qZA(),t.TgZ(75,"button",15),t.NdJ("click",function(){return e.getGraphInfo(1)}),t.TgZ(76,"mat-icon"),t._uU(77,"perm_identity"),t.qZA(),t._uU(78," Datos del tasker "),t.qZA(),t.TgZ(79,"button",15),t.NdJ("click",function(){return e.getGraphInfo(2)}),t.TgZ(80,"mat-icon"),t._uU(81,"room"),t.qZA(),t._uU(82," Ubicaci\xf3n actual "),t.qZA(),t.TgZ(83,"button",15),t.NdJ("click",function(){return e.getGraphInfo(3)}),t.TgZ(84,"mat-icon"),t._uU(85,"forum"),t.qZA(),t._uU(86," Conversar con el tasker "),t.qZA()()),2&i){const n=t.MAs(12),o=t.MAs(64),l=t.MAs(70);t.xp6(1),t.Q6J("buttons","110111")("nav_menu",!1)("bar_text",e.getTitleText()),t.xp6(1),t.Q6J("matMenuTriggerFor",n),t.xp6(4),t.Q6J("data",e.dataList)("prod_list",e.localFilter.products_name_sel)("pivot",e.pivot)("bartype",e.bartype),t.xp6(2),t.Q6J("data",e.dataList)("prod_list",e.localFilter.products_name_sel)("pivot",e.pivot)("bartype",e.bartype)("chunk",e.chunk),t.xp6(1),t.Q6J("matMenuTriggerFor",l),t.xp6(4),t.Q6J("matMenuTriggerFor",o),t.xp6(4),t.Oqu(e.graphtypeName),t.xp6(3),t.Q6J("ngIf",0===e.pivot),t.xp6(3),t.Q6J("ngIf",1===e.pivot),t.xp6(3),t.Q6J("ngIf",2===e.pivot),t.xp6(3),t.Q6J("ngIf",3===e.pivot),t.xp6(8),t.Q6J("ngIf","D"===e.chunk),t.xp6(3),t.Q6J("ngIf","M"===e.chunk),t.xp6(3),t.Q6J("ngIf","Y"===e.chunk)}},dependencies:[_.O5,N.G,T.VK,T.OP,T.p6,Z.Hw,L.g,A]})}return s})()}];let $=(()=>{class s{static#t=this.\u0275fac=function(i){return new(i||s)};static#e=this.\u0275mod=t.oAB({type:s});static#a=this.\u0275inj=t.cJS({imports:[k.Bz.forChild(B),k.Bz]})}return s})();var z=u(769),H=u(6483);const X=[{path:"",component:A}];let K=(()=>{class s{static#t=this.\u0275fac=function(i){return new(i||s)};static#e=this.\u0275mod=t.oAB({type:s});static#a=this.\u0275inj=t.cJS({imports:[k.Bz.forChild(X),k.Bz]})}return s})(),V=(()=>{class s{static#t=this.\u0275fac=function(i){return new(i||s)};static#e=this.\u0275mod=t.oAB({type:s});static#a=this.\u0275inj=t.cJS({imports:[_.ez,K,y.X]})}return s})(),W=(()=>{class s{static#t=this.\u0275fac=function(i){return new(i||s)};static#e=this.\u0275mod=t.oAB({type:s});static#a=this.\u0275inj=t.cJS({imports:[_.ez,$,z.O,C.ZX,y.X,T.Tx,Z.Ps,H.q,V]})}return s})()}}]);