"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[537],{4537:(N,g,r)=>{r.d(g,{x:()=>M});var _=r(3241),f=r(4344),v=r(7430),p=r(2283),y=r(4758),C=r(6806),b=r(1359),E=r(5061),A=r(3620),D=r(8035),L=r(1267);let M=(()=>{class h{constructor(e,t,n,a,d,s,c){this.sharedvar=e,this.dtb=t,this.snkBar=n,this.dg=a,this.ds=d,this.notif=s,this.pollServ=c,this.schemaAppoint={controls:[{name:"staff",label:"Responsable:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"pollgrp_id",label:"Tarea a ejecutar:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"datetime",label:"Fecha y hora:",type:"datetime-local",validators:{required:!0}},{name:"dateend",label:"Fecha y hora final sugerida:",type:"datetime-local",sideBtn:"more_time",validators:{required:!0}},{name:"sche_schedule",label:"Reagendar:",type:"select",style:"ml-4",selectOptions:[{key:"n",value:"Nunca"},{key:"d",value:"Diario"},{key:"s",value:"Semanal"},{key:"m",value:"Mensual"},{key:"o",value:"Otra frecuencia"}],default:"n",validators:{required:!0}},{name:"sche_other",label:"Frecuencia (d\xedas):",type:"number",style:"ml-4",default:0,validators:{}},{name:"notifMailList",label:"Lista de correo para notificar fallas:",type:"textarea",totalRows:4,style:"ml-4 w-full",validators:{}},{name:"notes",label:"Notas:",type:"textarea",totalRows:4,style:"w-full",validators:{}},{name:"crm_costum_name",label:"Cliente",type:"text",sideBtn:"people",style:"w-full",disabled:!0,validators:{}},{name:"contact",label:"Contacto",type:"text",style:"w-full",validators:{}},{name:"address",label:"Direcci\xf3n",type:"text",style:"w-full",validators:{}},{name:"geoLoc",label:"Geolocalizaci\xf3n",type:"text",style:"w-full",sideBtn:"room",disabled:!0,validators:{}}]},this.messageSchema={controls:[{name:"message",label:"Mensaje:",type:"textarea",totalRows:4,style:"w-full",validators:{required:!0}}]},this.groupRefTrue=[],this.taskerData={picture:{title:"Foto",type:"blob-picture"},active:{title:"Activo",type:"boolean"},id:{title:"Identificaci\xf3n",type:"string"},names:{title:"Nombres",type:"string"},lastnames:{title:"Apellidos",type:"string"},age:{title:"Edad",type:"number"},address:{title:"Direcci\xf3n",type:"string"},city:{title:"Ciudad",type:"string"},email:{title:"Correo",type:"string"},phone:{title:"Tel\xe9fono",type:"string"},platform:{title:"Plataform pago",type:"string"},platform_phone:{title:"Tel\xe9fono plataforma",type:"string"},legal_age:{title:"Edad legal",type:"boolean"},stars:{title:"Estrellas",type:"number"},studyLevel:{title:"Nivel de estudio",type:"number"}}}startAppointData(e){if(this.staffList=e,this.groupRefTrue=this.pollServ.getGroupRef(),this.schemaAppoint.controls){const t=this.schemaAppoint.controls.find(a=>"pollgrp_id"===a.name);t&&(t.selectOptions=this.groupRefTrue);const n=this.schemaAppoint.controls.find(a=>"staff"===a.name);n&&(n.selectOptions=[],e.forEach(a=>{a._id&&n.selectOptions?.push({key:a._id,value:`${a.names} ${a.lastnames||""}`})}))}}getPollGrpName(e){if(e){const t=this.groupRefTrue.find(n=>n.key===e);if(t)return t.value}return""}onDelAppoint(e,t){!e.appoint||0===e.appoint.length||this.snkBar.open("Eliminar item de la agenda?.","Ok",{duration:5e3}).onAction().subscribe(n=>{e.appoint?.splice(t,1),this.dtb.updateStaffAsync(e)})}onAddEditAppoint(e,t,n=!0){var a=this;let d,s,c="Agenda ";const l=null===e||-1===t;if(null==e&&(e=this.staffList[0]),e.appoint||(e.appoint=[]),s=-1===t?this.appointBasic(e,"appoint"):e.appoint[t],c+=l?"Nueva":`${e.names} ${e.lastnames||""}`,this.schemaAppoint.controls){let m=-1;m=this.schemaAppoint.controls.findIndex(i=>"contact"===i.name),m>=0&&(this.schemaAppoint.controls[m].type="text"),m=this.schemaAppoint.controls.findIndex(i=>"staff"===i.name),this.schemaAppoint.controls[m].disabled=!l,m=this.schemaAppoint.controls.findIndex(i=>"geoLoc"===i.name),m>=0&&(this.schemaAppoint.controls[m].sideBtn=n?"room":"")}e.appoint&&s&&(d={staff:e._id,...s}),this.dg.aDefault({schema:this.schemaAppoint,title:c,value:d,dgwidth:400,function:[{name:"crm_costum_name",self:this,btn_source:1,function:this.getCostumer1},{name:"datetime",self:this,btn_source:0,function:this.updateEndTime},{name:"dateend",self:this,btn_source:1,function:this.addTime},{name:"geoLoc",self:this,btn_source:1,function:this.geolocation}]}).subscribe(function(){var m=(0,_.Z)(function*(i){if(i){const u=a.staffList.find(R=>R._id==i.staff);if(!u)return;u.appoint||(u.appoint=[]),i.dateend<=i.datetime&&(i.dateend=i.datetime+a.sharedvar.addMinutes(15)),i.staff_name=`${u.names} ${u.lastnames}`,delete i._btnEvent_,delete i._btnclick_,delete i._propName_,delete i._valid_,delete i.staff,a.dg.updatePropResult(s,i),a.selectedCostumer&&(s.contact===a.selectedCostumer.linkup_1?(s.email=a.selectedCostumer.email_1,s.phone=a.selectedCostumer.phone_1):(s.email=a.selectedCostumer.email_2,s.phone=a.selectedCostumer.phone_2),s.defa_values={crm_costum_id:a.selectedCostumer.id,crm_costum_name:a.selectedCostumer.name,crm_costum_contact:s.contact,crm_costum_email:s.email,crm_costum_phone:s.phone,crm_note:s.notes}),s.pollgrp_model_name=a.getPollGrpName(i.pollgrp_id),s.reported=!1,s.ended=!1,l?u.appoint.push(s):u.appoint[t]=s,a.dtb.updateStaffAsync(u);const O=`<h3>Agenda: ${s.pollgrp_model_name}</h3>\n          <p><strong>Fecha:</strong> ${a.sharedvar.formatNumber2DateTime(s.datetime,"/")}</p>\n          <p><strong>Cliente:</strong> ${s.crm_costum_name||"No aplica"}</p>\n          <p><strong>Notas:</strong> ${s.notes||"Ninguna"}</p>\n        `;a.dtb.otherNotification({to:u.email||"",subject:"Agenda",html:O,data:{}});const P=`Agenda ->${a.sharedvar.formatNumber2DateTime(s.datetime,"/")} Formulario: ${s.pollgrp_model_name} notas: ${s.notes}`;a.notif.sendCommand({cmd:"appoint",user_id:a.sharedvar.staff._id,usert_id:u._id,data:P})}});return function(i){return m.apply(this,arguments)}}())}onMessage2(e,t){var n=this;this.dg.aDefault({schema:this.messageSchema,title:"Mensaje a "+e||0,dgwidth:400,dgheigth:300}).subscribe(function(){var c=(0,_.Z)(function*(l){l&&n.notif.sendCommand({cmd:"message",user_id:n.sharedvar.staff._id,usert_id:t,data:{msg:{msg:l.message,who:n.sharedvar.staff.names||""},pollGrpName:n.sharedvar.staff.names||""}})});return function(l){return c.apply(this,arguments)}}())}getCostumer1(e,t,n){return(0,_.Z)(function*(){if(!t)return;const a=[],d=yield e.dtb.getActiveCRMCostumAsync();if(!d)return;d.forEach(l=>{l&&a.push({selected:!1,myid:l.id,name:l.name})});const s={title:"Seleccione Cliente",dgheigth:450,viewfilter:!0,viewAdd:!0,multiSelect:!1,valuelst:a},c=yield(0,f.z)(e.ds.aSelectDefault(s));if(c){if(!0===c.new){const o=yield e.newCostumer(e,"owner");if(!o)return{schema:n,value:t};e.selectedCostumer=o}else e.selectedCostumer=d.find(o=>o.name===c[0].name);t.crm_costum_name=e.selectedCostumer.name,t.crm_costum_mail=e.selectedCostumer.email,t.address=e.selectedCostumer.address;const l=n.controls?.findIndex(o=>"contact"===o.name);if(l&&l>=0&&n.controls){const o=[];e.selectedCostumer?.linkup_1&&o.push({key:e.selectedCostumer.linkup_1,value:e.selectedCostumer.linkup_1}),e.selectedCostumer?.linkup_2&&o.push({key:e.selectedCostumer?.linkup_2,value:e.selectedCostumer?.linkup_2}),n.controls[l].type="select",n.controls[l].selectOptions=o}}return{schema:n,value:t}})()}newCostumer(e,t){return(0,_.Z)(function*(){let n={schema:v.Cn,title:"Datos del cliente",dgwidth:550,dgheigth:715};const a=yield(0,f.z)(e.dg.aDefault(n));return a?(delete a._valid_,delete a._btnEvent_,delete a._propName_,a.ownertype=[t],a.active=!0,yield e.dtb.createCostumAsync(a)):null})()}updateEndTime(e,t,n){return(0,_.Z)(function*(){if(t)return t.dateend=Number(t.datetime)+e.sharedvar.addMinutes(15),{schema:null,value:t}})()}addTime(e,t,n){return(0,_.Z)(function*(){if(t)return t.dateend=Number(t.dateend)+e.sharedvar.addMinutes(15),{schema:null,value:t}})()}geolocation(e,t,n){return(0,_.Z)(function*(){if(!t)return;(!t.geoLoc||0===t.geoLoc.length)&&(t.geoLoc=yield e.sharedvar.getLocalization());const d={title:"Geo localizaci\xf3n",dgheigth:600,value:[e.staff2analitic(0,t,t)]},s=yield(0,f.z)(e.dg.aMap(d));return s&&(t.geoLoc=s.geoLocStart),{schema:null,value:t}})()}onFilter(e){}staff2analitic(e,t,n){return{_id:`${t._id}:${e}`,date_ini:n.datetime,date_end:n.dateend,geoLocStart:n.geoLoc,tasker_id:t._id||"",tasker_name:t.names+" "+(t.lastnames||""),activity_id:n.pollgrp_id||"",activity_name:n.pollgrp_model_name||"No asignada",costumer_name:n.crm_costum_name||"",crm_products:[],ended:!1}}appointBasic(e,t){return{type:t,datetime:this.sharedvar.dateNow(),dateend:this.sharedvar.dateNow(),ended:!1,reported:!1,owner:this.sharedvar.staff._id||"",staff_name:`${e.names||""} ${e.lastnames||""}`,email:e.email}}static#e=this.\u0275fac=function(t){return new(t||h)(p.LFG(y.D),p.LFG(C.k),p.LFG(b.ux),p.LFG(E.x),p.LFG(A.n),p.LFG(D.$),p.LFG(L.n))};static#t=this.\u0275prov=p.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()}}]);