"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[911],{911:(O,E,d)=>{d.r(E),d.d(E,{PollCrmModule:()=>h});var v=d(7087),A=d(3759),x=d(3241),e=d(2283),Z=d(4758),D=d(3620),L=d(6806),M=d(4537),S=d(3578),T=d(9347),P=d(8464);const b=["editControlTrigger"];function G(r,f){if(1&r){const t=e.EpF();e.TgZ(0,"div",12)(1,"div",13),e._uU(2),e.qZA(),e.TgZ(3,"div",14),e._uU(4,"Contacto:"),e.qZA(),e._uU(5,"\xa0 "),e.TgZ(6,"div",15),e._uU(7),e.qZA(),e._UZ(8,"div",16),e.TgZ(9,"div",14),e._uU(10,"Tel\xe9fono:"),e.qZA(),e._uU(11,"\xa0 "),e.TgZ(12,"div",17),e._uU(13),e.qZA(),e.TgZ(14,"mat-icon",18),e.NdJ("click",function(){const m=e.CHM(t).index,_=e.oxw(2);return e.KtG(_.onDeleteCost(m))}),e._uU(15,"delete"),e.qZA()()}if(2&r){const t=f.$implicit,o=e.oxw(2);e.xp6(2),e.Oqu(o.getStrData(1,t)),e.xp6(5),e.Oqu(o.getStrData(3,t)),e.xp6(6),e.Oqu(o.getStrData(4,t))}}function i(r,f){if(1&r&&(e.TgZ(0,"div")(1,"div",10),e.YNc(2,G,16,3,"div",11),e.qZA()()),2&r){const t=e.oxw();e.xp6(2),e.Q6J("ngForOf",t.sharedvar.pollGrpExecuted.costumerList)}}function n(r,f){if(1&r){const t=e.EpF();e.TgZ(0,"div",20)(1,"div",21),e._uU(2),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.qZA(),e.TgZ(5,"mat-icon",18),e.NdJ("click",function(){const m=e.CHM(t).index,_=e.oxw(2);return e.KtG(_.onDeleteProd(m))}),e._uU(6,"delete"),e.qZA()()}if(2&r){const t=f.$implicit,o=e.oxw(2);e.xp6(2),e.Oqu(o.getStrData(0,t)),e.xp6(2),e.Oqu(o.getStrData(1,t))}}function s(r,f){if(1&r&&(e.TgZ(0,"div")(1,"div",10),e.YNc(2,n,7,2,"div",19),e.qZA()()),2&r){const t=e.oxw();e.xp6(2),e.Q6J("ngForOf",t.sharedvar.pollGrpExecuted.productList)}}const g=[{path:"",component:(()=>{class r{constructor(t,o,c,m){this.sharedvar=t,this.ds=o,this.dtb=c,this.staffServ=m,this.tabSelected=0,this.tabSelectedName="Lista de Clientes"}getClicked(t){switch(t.index){case 2:0===this.tabSelected?this.onSelCost():this.onSelProd();break;case 3:let o=document.getElementById("spanTrigger");o&&(o.style.display="",o.style.position="absolute",o.style.left=t.pageX+5+"px",o.style.top=t.pageY+5+"px",this.editControlTrigger.openMenu())}}selCostumer(){this.tabSelected=0,this.tabSelectedName="Lista de Clientes"}selProd(){this.tabSelected=1,this.tabSelectedName="Lista de Productos"}onSelProd(){var t=this;return(0,x.Z)(function*(){const o=[],c=yield t.dtb.getAllCRMProdAsync();c&&(c.forEach(_=>{_&&o.push({selected:!1,myid:_.id,name:_.description,hide1:_._id})}),t.ds.aSelectDefault({title:"Seleccione Productos",dgheigth:450,viewfilter:!0,viewAdd:!1,multiSelect:!0,valuelst:o}).subscribe(function(){var _=(0,x.Z)(function*(u){u&&(u.forEach(C=>{t.sharedvar.pollGrpExecuted.productList?.includes(C.myid)||t.sharedvar.pollGrpExecuted.productList?.push(`${C.myid}:${C.name}:${C.hide1}`)}),yield t.dtb.updatePollGroupAsync(t.sharedvar.pollGrpExecuted))});return function(u){return _.apply(this,arguments)}}()))})()}onDeleteProd(t){var o=this;return(0,x.Z)(function*(){o.sharedvar.pollGrpExecuted.productList?.splice(t,1),yield o.dtb.updatePollGroupAsync(o.sharedvar.pollGrpExecuted)})()}getStrData(t,o){return o.split(":")[t]||""}onSelCost(){var t=this;return(0,x.Z)(function*(){const o=[],c=yield t.dtb.getActiveCRMCostumAsync();c&&(c.forEach(_=>{if(_){const u=_;0===t.sharedvar.pollGrpExecuted.costumerList?.filter(p=>p.split(":")[0].includes(u.id))?.length&&o.push({selected:!1,myid:u.id,name:u.name,hide1:u._id,hide2:u.linkup_1,hide3:u.phone_1})}}),t.ds.aSelectDefault({title:"Seleccione Clientes",dgheigth:450,viewfilter:!0,viewAdd:!0,multiSelect:!0,valuelst:o}).subscribe(function(){var _=(0,x.Z)(function*(u){if(u){let C="";if(!0===u.new){const p=yield t.staffServ.newCostumer(t.staffServ);if(!p)return;C=`${p.id}:${p.name}:${p._id}:${p.linkup_1}:${p.phone_1}`,t.sharedvar.pollGrpExecuted.costumerList?.push(C)}else u.forEach(p=>{C=`${p.myid}:${p.name}:${p.hide1}:${p.hide2}:${p.hide3}`,t.sharedvar.pollGrpExecuted.costumerList?.push(C)});t.sharedvar.pollGrpExecuted.costumerList?.sort((p,R)=>p.split(":")[1].localeCompare(R.split(":")[1])),yield t.dtb.updatePollGroupAsync(t.sharedvar.pollGrpExecuted)}});return function(u){return _.apply(this,arguments)}}()))})()}onDeleteCost(t){var o=this;return(0,x.Z)(function*(){o.sharedvar.pollGrpExecuted.costumerList?.splice(t,1),yield o.dtb.updatePollGroupAsync(o.sharedvar.pollGrpExecuted)})()}static#e=this.\u0275fac=function(o){return new(o||r)(e.Y36(Z.D),e.Y36(D.n),e.Y36(L.k),e.Y36(M.x))};static#t=this.\u0275cmp=e.Xpm({type:r,selectors:[["app-poll-crm"]],viewQuery:function(o,c){if(1&o&&e.Gf(b,5),2&o){let m;e.iGM(m=e.CRH())&&(c.editControlTrigger=m.first)}},decls:22,vars:7,consts:[[1,"flex","flex-col","max-h-screen"],[3,"buttons","nav_menu","onClicked"],["id","spanTrigger",3,"matMenuTriggerFor"],["editControlTrigger","matMenuTrigger"],[1,"h-10","flex","items-center","justify-center","bg-slate-100","text-xl"],[3,"matMenuTriggerFor"],[1,"flex-1","m-2","overflow-scroll"],[4,"ngIf"],["controlEdit","matMenu"],["mat-menu-item","",3,"click"],[1,"flex-col","flex-wrap","p-2","gap-1"],["class","h-7 flex gap-1 mt-1 border-b border-gray-100 font-thin text-sm",4,"ngFor","ngForOf"],[1,"h-7","flex","gap-1","mt-1","border-b","border-gray-100","font-thin","text-sm"],[1,"flex-1","font-medium"],[1,"font-thin"],[1,"w-60","font-thin","text-gray-400"],[1,"w-2"],[1,"w-28","font-thin","text-gray-400"],[1,"text-gray-200","hover:text-violet-500",3,"click"],["class","h-10 flex gap-1 border-b border-gray-100 font-thin text-sm",4,"ngFor","ngForOf"],[1,"h-10","flex","gap-1","border-b","border-gray-100","font-thin","text-sm"],[1,"w-16"]],template:function(o,c){if(1&o&&(e.TgZ(0,"div",0)(1,"app-header",1),e.NdJ("onClicked",function(_){return c.getClicked(_)}),e.qZA(),e._UZ(2,"span",2,3),e.TgZ(4,"div",4)(5,"div"),e._uU(6),e.qZA(),e.TgZ(7,"mat-icon",5),e._uU(8,"arrow_drop_down"),e.qZA()(),e.TgZ(9,"div",6),e.YNc(10,i,3,1,"div",7),e.YNc(11,s,3,1,"div",7),e.qZA(),e.TgZ(12,"mat-menu",null,8)(14,"button",9),e.NdJ("click",function(){return c.selCostumer()}),e.TgZ(15,"mat-icon"),e._uU(16,"people"),e.qZA(),e._uU(17," Seleccionar Clientes "),e.qZA(),e.TgZ(18,"button",9),e.NdJ("click",function(){return c.selProd()}),e.TgZ(19,"mat-icon"),e._uU(20,"shopping_cart"),e.qZA(),e._uU(21," Seleccionar Productos "),e.qZA()()()),2&o){const m=e.MAs(13);e.xp6(1),e.Q6J("buttons","101100")("nav_menu",!0),e.xp6(1),e.Q6J("matMenuTriggerFor",m),e.xp6(4),e.Oqu(c.tabSelectedName),e.xp6(1),e.Q6J("matMenuTriggerFor",m),e.xp6(3),e.Q6J("ngIf",0===c.tabSelected),e.xp6(1),e.Q6J("ngIf",1===c.tabSelected)}},dependencies:[v.sg,v.O5,S.G,T.VK,T.OP,T.p6,P.Hw]})}return r})()}];let l=(()=>{class r{static#e=this.\u0275fac=function(o){return new(o||r)};static#t=this.\u0275mod=e.oAB({type:r});static#i=this.\u0275inj=e.cJS({imports:[A.Bz.forChild(g),A.Bz]})}return r})();var y=d(769);let h=(()=>{class r{static#e=this.\u0275fac=function(o){return new(o||r)};static#t=this.\u0275mod=e.oAB({type:r});static#i=this.\u0275inj=e.cJS({imports:[v.ez,l,y.O,T.Tx,P.Ps]})}return r})()},4537:(O,E,d)=>{d.d(E,{x:()=>P});var v=d(3241),A=d(4344),x=d(7430),e=d(2283),Z=d(4758),D=d(6806),L=d(1359),M=d(3638),S=d(3620),T=d(8035);let P=(()=>{class b{constructor(i,n,s,a,g,l){this.sharedvar=i,this.dtb=n,this.snkBar=s,this.dg=a,this.ds=g,this.notif=l,this.schemaAppoint={controls:[{name:"staff",label:"Responsable:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"pollgrp_id",label:"Tarea a ejecutar:",type:"select",style:"w-full",selectOptions:[],validators:{required:!0}},{name:"datetime",label:"Fecha y hora:",type:"datetime-local",validators:{required:!0}},{name:"dateend",label:"Fecha y hora final sugerida:",type:"datetime-local",sideBtn:"more_time",validators:{required:!0}},{name:"notes",label:"Notas:",type:"textarea",totalRows:4,style:"w-full",validators:{required:!0}},{name:"crm_costum_name",label:"Cliente",type:"text",sideBtn:"people",style:"w-full",disabled:!0,validators:{}},{name:"contact",label:"Contacto",type:"text",style:"w-full",validators:{}},{name:"address",label:"Direcci\xf3n",type:"text",style:"w-full",validators:{}},{name:"geoLoc",label:"Geolocalizaci\xf3n",type:"text",style:"w-full",sideBtn:"room",disabled:!0,validators:{}}]},this.messageSchema={controls:[{name:"message",label:"Mensaje:",type:"textarea",totalRows:4,style:"w-full",validators:{required:!0}}]},this.groupRefTrue=[],this.taskerData={picture:{title:"Foto",type:"blob-picture"},active:{title:"Activo",type:"boolean"},id:{title:"Identificaci\xf3n",type:"string"},names:{title:"Nombres",type:"string"},lastnames:{title:"Apellidos",type:"string"},age:{title:"Edad",type:"number"},address:{title:"Direcci\xf3n",type:"string"},city:{title:"Ciudad",type:"string"},email:{title:"Correo",type:"string"},phone:{title:"Tel\xe9fono",type:"string"},platform:{title:"Plataform pago",type:"string"},platform_phone:{title:"Tel\xe9fono plataforma",type:"string"},legal_age:{title:"Edad legal",type:"boolean"},stars:{title:"Estrellas",type:"number"},studyLevel:{title:"Nivel de estudio",type:"number"}}}startAppointData(i){if(this.staffList=i,this.getGroupRef(),this.schemaAppoint.controls){const n=this.schemaAppoint.controls.find(a=>"pollgrp_id"===a.name);n&&(n.selectOptions=this.groupRefTrue);const s=this.schemaAppoint.controls.find(a=>"staff"===a.name);s&&(s.selectOptions=[],i.forEach(a=>{a._id&&s.selectOptions?.push({key:a._id,value:`${a.names} ${a.lastnames||""}`})}))}}getPollGrpName(i){if(i){const n=this.groupRefTrue.find(s=>s.key===i);if(n)return n.value}return""}getGroupRef(){this.groupRefTrue=[],this.getRefNodeTrue(this.sharedvar.pollGroupIndex)}getRefNodeTrue(i){if(i.children)for(let n=0;n<i.children.length;n++){const s=i.children[n];if(s.ref)this.groupRefTrue.push({key:s.id,value:s.model_name||s.name});else if(s.children&&s.children.length>0)return this.getRefNodeTrue(s)}}onDelAppoint(i,n){!i.appoint||0===i.appoint.length||this.snkBar.open("Eliminar item de la agenda?.","Ok",{duration:5e3}).onAction().subscribe(s=>{i.appoint?.splice(n,1),this.dtb.updateStaffAsync(i)})}onAddEditAppoint(i,n,s=!0){var a=this;let g,l,y="Agenda ";const h=null===i||-1===n;if(null==i&&(i=this.staffList[0]),i.appoint||(i.appoint=[]),l=-1===n?this.appointBasic(i,"appoint"):i.appoint[n],y+=h?"Nueva":`${i.names} ${i.lastnames||""}`,this.schemaAppoint.controls){let f=-1;f=this.schemaAppoint.controls.findIndex(t=>"contact"===t.name),f>=0&&(this.schemaAppoint.controls[f].type="text"),f=this.schemaAppoint.controls.findIndex(t=>"staff"===t.name),this.schemaAppoint.controls[f].disabled=!h,f=this.schemaAppoint.controls.findIndex(t=>"geoLoc"===t.name),f>=0&&(this.schemaAppoint.controls[f].sideBtn=s?"room":"")}i.appoint&&l&&(g={staff:i._id,...l}),this.dg.aDefault({schema:this.schemaAppoint,title:y,value:g,dgwidth:400,function:[{name:"crm_costum_name",self:this,btn_source:!0,function:this.getCostumer1},{name:"datetime",self:this,btn_source:!1,function:this.updateEndTime},{name:"dateend",self:this,btn_source:!0,function:this.addTime},{name:"geoLoc",self:this,btn_source:!0,function:this.geolocation}]}).subscribe(function(){var f=(0,v.Z)(function*(t){if(t){const o=a.staffList.find(c=>c._id==t.staff);if(!o)return;o.appoint||(o.appoint=[]),t.dateend<=t.datetime&&(t.dateend=t.datetime+a.sharedvar.addMinutes(15)),t.staff_name=`${o.names} ${o.lastnames}`,delete t._btnEvent_,delete t._btnclick_,delete t._propName_,delete t._valid_,delete t.staff,a.dg.updatePropResult(l,t),a.selectedCostumer&&(l.contact===a.selectedCostumer.linkup_1?(l.email=a.selectedCostumer.email_1,l.phone=a.selectedCostumer.phone_1):(l.email=a.selectedCostumer.email_2,l.phone=a.selectedCostumer.phone_2),l.defa_values={crm_costum_id:a.selectedCostumer.id,crm_costum_name:a.selectedCostumer.name,crm_costum_contact:l.contact,crm_costum_email:l.email,crm_costum_phone:l.phone,crm_note:l.notes}),l.pollgrp_model_name=a.getPollGrpName(t.pollgrp_id),h?o.appoint.push(l):o.appoint[n]=l,a.dtb.updateStaffAsync(o)}});return function(t){return f.apply(this,arguments)}}())}onMessage2(i,n){var s=this;this.dg.aDefault({schema:this.messageSchema,title:"Mensaje a "+i||0,dgwidth:400,dgheigth:300}).subscribe(function(){var y=(0,v.Z)(function*(h){h&&s.notif.sendCommand({cmd:"message",user_id:s.sharedvar.staff._id,usert_id:n,data:{msg:{msg:h.message,who:s.sharedvar.staff.names||""},pollGrpName:s.sharedvar.staff.names||""}})});return function(h){return y.apply(this,arguments)}}())}getCostumer1(i,n,s){return(0,v.Z)(function*(){if(!n)return;const a=[],g=yield i.dtb.getActiveCRMCostumAsync();if(!g)return;g.forEach(h=>{h&&a.push({selected:!1,myid:h.id,name:h.name})});const l={title:"Seleccione Cliente",dgheigth:450,viewfilter:!0,viewAdd:!0,multiSelect:!1,valuelst:a},y=yield(0,A.z)(i.ds.aSelectDefault(l));if(y){if(!0===y.new){const r=yield i.newCostumer(i);if(!r)return{schema:s,value:n};i.selectedCostumer=r}else i.selectedCostumer=g.find(r=>r.name===y[0].name);n.crm_costum_name=i.selectedCostumer.name,n.address=i.selectedCostumer.address;const h=s.controls?.findIndex(r=>"contact"===r.name);if(h&&h>=0&&s.controls){const r=[];i.selectedCostumer?.linkup_1&&r.push({key:i.selectedCostumer.linkup_1,value:i.selectedCostumer.linkup_1}),i.selectedCostumer?.linkup_2&&r.push({key:i.selectedCostumer?.linkup_2,value:i.selectedCostumer?.linkup_2}),s.controls[h].type="select",s.controls[h].selectOptions=r}}return{schema:s,value:n}})()}newCostumer(i){return(0,v.Z)(function*(){let n={schema:x.Cn,title:"Datos del cliente",dgwidth:550,dgheigth:715};const s=yield(0,A.z)(i.dg.aDefault(n));return s?(delete s._valid_,delete s._btnEvent_,delete s._propName_,s.active=!0,yield i.dtb.createCostumAsync(s)):null})()}updateEndTime(i,n,s){return(0,v.Z)(function*(){if(n)return n.dateend=Number(n.datetime)+i.sharedvar.addMinutes(15),{schema:null,value:n}})()}addTime(i,n,s){return(0,v.Z)(function*(){if(n)return n.dateend=Number(n.dateend)+i.sharedvar.addMinutes(15),{schema:null,value:n}})()}geolocation(i,n,s){return(0,v.Z)(function*(){if(!n)return;(!n.geoLoc||0===n.geoLoc.length)&&(n.geoLoc=yield i.sharedvar.getLocalization());const g={title:"Geo localizaci\xf3n",dgheigth:600,value:[i.staff2analitic(0,n,n)]},l=yield(0,A.z)(i.dg.aMap(g));return l&&(n.geoLoc=l.geoLocStart),{schema:null,value:n}})()}onFilter(i){}staff2analitic(i,n,s){return{_id:`${n._id}:${i}`,date_ini:s.datetime,date_end:s.dateend,geoLocStart:s.geoLoc,tasker_id:n._id||"",tasker_name:n.names+" "+(n.lastnames||""),activity_id:s.pollgrp_id||"",activity_name:s.pollgrp_model_name||"No asignada",costumer_name:s.crm_costum_name||"",crm_products:[],ended:!1}}appointBasic(i,n){return{type:n,datetime:this.sharedvar.dateNow(),dateend:this.sharedvar.dateNow(),ended:!1,owner:this.sharedvar.staff._id||"",staff_name:`${i.names} ${i.lastnames}`}}static#e=this.\u0275fac=function(n){return new(n||b)(e.LFG(Z.D),e.LFG(D.k),e.LFG(L.ux),e.LFG(M.x),e.LFG(S.n),e.LFG(T.$))};static#t=this.\u0275prov=e.Yz7({token:b,factory:b.\u0275fac,providedIn:"root"})}return b})()}}]);