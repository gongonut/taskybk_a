"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[157],{6157:($,h,s)=>{s.r(h),s.d(h,{AppointListModule:()=>H});var _=s(7087),g=s(3759),d=s(3241),t=s(2283),b=s(4758),y=s(4537),Z=s(6806),k=s(5330),x=s(1682),L=s(8035),C=s(3578),f=s(9347),v=s(8464),F=s(9554),N=s(5802);const M=["editControlTrigger"],U=["chartTrigger"];function G(o,u){if(1&o){const e=t.EpF();t.TgZ(0,"div",18),t.NdJ("mousemove",function(i){t.CHM(e);const n=t.oxw();return t.KtG(n.mousepos(i))}),t.TgZ(1,"div",19)(2,"app-time-line",20),t.NdJ("onSelect",function(i){t.CHM(e);const n=t.oxw();return t.KtG(n.onSelect(i))}),t.qZA()(),t._UZ(3,"span",21,22),t.qZA()}if(2&o){const e=t.oxw(),a=t.MAs(43);t.xp6(2),t.Q6J("data",e.dataList)("pivot",e.pivot)("bartype",e.bartype),t.xp6(1),t.Q6J("matMenuTriggerFor",a)}}function J(o,u){if(1&o){const e=t.EpF();t.TgZ(0,"div",23)(1,"app-map",24),t.NdJ("markerclick",function(i){t.CHM(e);const n=t.oxw();return t.KtG(n.getMarkerClicked(i))}),t.qZA()()}if(2&o){const e=t.oxw();t.xp6(1),t.Q6J("reset",e.reset)("markerlist",e.dataList)}}function D(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function S(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function I(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function E(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}const q=[{path:"",component:(()=>{class o{constructor(e,a,i,n,l,p){this.sharedvar=e,this.staffServ=a,this.dtb=i,this.dg=n,this.data2excel=l,this.notif=p,this.staffList=[],this.pivot=0,this.bartype=0,this.chunk="D",this.graphtypeName="Linea de tiempo apilado",this.mpos={x:-1,y:-1},this.bar_txt="",this.reset=0}ngOnInit(){var e=this;return(0,d.Z)(function*(){e.staffSub=e.notif.getStaffNotif_Obs().subscribe({next:l=>{e.executeFilter()}}),e.staffList=yield e.dtb.getStaffByFilterAsync({queryType:1,active:!0,stars:0,rol:"P"}),e.staffServ.startAppointData(e.staffList);const a=new Date,i=a.setHours(0,0,0,0),n=a.setHours(23,59,59,999);e.localFilter={crm:"T",staff__id:[],pollGrpData:[],costumers:[],products:[],products_name_sel:[],date_ini:i,date_end:n},e.executeFilter()})()}ngOnDestroy(){this.staffSub&&this.staffSub.unsubscribe()}setGraphType(e){switch(this.bartype=e,e){case 0:this.graphtypeName="Linea de tiempo apilado";break;case 1:this.graphtypeName="Mapa"}}executeFilter(){this.localFilter&&(this.dataList=[],this.getTitleText(),this.staffList.forEach(e=>{if(e.appoint&&(0===this.localFilter.staff__id.length||-1!==this.localFilter.staff__id.findIndex(a=>e._id===a))){for(let a=0;a<e.appoint.length;a++){let i=!0;const n=e.appoint[a];i=0===this.localFilter.pollGrpData.length||this.localFilter.pollGrpData.findIndex(p=>p===n.pollgrp_id)>-1,i=0===this.localFilter.costumers.length||this.localFilter.costumers.findIndex(p=>p===n.costumer)>-1,i=this.localFilter.date_ini>=n.datetime&&this.localFilter.date_end<=n.dateend,this.dataList.push({_id:`${e._id}:${a}`,date_ini:n.datetime,date_end:n.dateend,geoLocStart:n.geoLoc,tasker_id:e._id||"",tasker_name:e.names+" "+(e.lastnames||""),activity_id:n.pollgrp_id||"",activity_name:n.pollgrp_model_name||"No asignada",costumer_name:n.costumer||"",crm_products:[]})}this.dataList.sort((a,i)=>Number(i.date_ini)-Number(a.date_ini))}}))}getClicked(e){var a=this;return(0,d.Z)(function*(){switch(e.index){case 1:a.filterDialog();break;case 2:a.addAppoint();break;case 3:let i=document.getElementById("spanTrigger");i&&(i.style.display="",i.style.position="absolute",i.style.left=e.pageX+5+"px",i.style.top=e.pageY+5+"px",a.editControlTrigger.openMenu());break;case 4:yield a.executeFilter()}})()}addAppoint(){this.staffServ.onAddEditAppoint(null,-1)}getTitleText(){this.localFilter&&(this.bar_txt="",this.localFilter.pollGrpData&&this.localFilter.pollGrpData.length>0&&(this.bar_txt+="Modelos - "),this.localFilter.staff__id&&this.localFilter.staff__id.length>0&&(this.bar_txt+="Tasker - "),this.localFilter.costumers&&this.localFilter.costumers.length>0&&(this.bar_txt+="Clientes - "),this.localFilter.products&&this.localFilter.products.length>0&&(this.bar_txt+="Productos - "),this.bar_txt+=`Fecha desde ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"/")}\n     hasta ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"/")}`)}getMarkerClicked(e){var a=this;return(0,d.Z)(function*(){const i=e.target.options.alt.split(":"),n=a.staffList.find(l=>l._id===i[0]);if(n){if("click"===e.type)a.staffServ.onAddEditAppoint(n,Number(i[1]),!1);else if("moveend"===e.type){const l=e.target._latlng.lat,p=e.target._latlng.lng;n.appoint[Number(i[1])].geoLoc={lat:l,lng:p},a.dtb.updateStaffAsync(n)}a.reset++}})()}filterDialog(){var e=this;return(0,d.Z)(function*(){e.sharedvar.wait=!0;let a=[],i=[],n=[],l=[];(yield e.dtb.getStaffByFilterAsync({queryType:3,active:!0,stars:0,rol:"K"})).forEach(c=>{a.push({key:c._id,value:`${c.names||c.email} ${c.lastnames||""}`})}),(yield e.dtb.getPollGrpActiveAsync()).forEach(c=>{"index"!==c.id&&i.push({key:c._id,value:c.name})}),(yield e.dtb.getActiveCRMCostumAsync()).forEach(c=>{n.push({key:c.id,value:c.name})}),(yield e.dtb.getAllCRMProdAsync()).forEach(c=>{l.push({key:c.id,value:c.name})}),e.dg.aDefault({schema:{controls:[{name:"staff__id",label:"Taskers:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:a},{name:"pollGrpData",label:"Modelos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:i},{name:"costumers",label:"Clientes:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:n},{name:"products",label:"Productos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:l},{name:"date_ini",label:"Fecha inicio:",type:"date",validators:{}},{name:"date_end",label:"Fecha final:",type:"date",validators:{}}]},title:"Filtros",dgheigth:615,dgwidth:550,value:e.localFilter}).subscribe(function(){var c=(0,d.Z)(function*(r){if(e.sharedvar.wait=!1,r){if(r.alldates)r.date_ini=0,r.date_end=0;else{let m=new Date(r.date_ini||0);r.date_ini=m.setHours(0,0,0,0),m=new Date(r.date_end||0),r.date_end=m.setHours(23,59,59,999)}const T=[];r.products&&r.products.length>0&&r.products.forEach(m=>{const A=l.find(R=>R.key===m);A&&T.push(A.value)}),e.localFilter={crm:"T",staff__id:r.staff__id,pollGrpData:r.pollGrpData,costumers:r.costumers,products:r.products,date_ini:r.date_ini,date_end:r.date_end,products_name_sel:[...T]},yield e.executeFilter()}});return function(r){return c.apply(this,arguments)}}())})()}mousepos(e){this.mpos.x=e.clientX,this.mpos.y=e.clientY}onSelect(e){var a=this;return(0,d.Z)(function*(){let i=document.getElementById("chartTrigger");i&&(a.graphevent=e,i.style.display="",i.style.position="absolute",i.style.left=a.mpos.x+5+"px",i.style.top=a.mpos.y+5+"px",a.chartTrigger.openMenu())})()}getGraphInfo(e){var a=this;return(0,d.Z)(function*(){const i=a.graphevent.meta.split(":"),n=a.staffList.find(p=>p._id===i[0]);if(n?.appoint&&n.appoint[Number(i[1])])switch(e){case 0:case 1:case 2:break;case 4:a.staffServ.onAddEditAppoint(n,Number(i[1]));break;case 5:a.staffServ.onDelAppoint(n,Number(i[1]))}})()}onExportexcel(){const e=`Reporte CRM fechas ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"-")} - \n    ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"-")}`;this.data2excel.excelExport(this.dataList,e,"CRM",this.header,[])}onSelPivot(e){this.pivot=e}getPivotName(){switch(this.pivot){case 0:return"Tasker";case 1:return"Actividades";case 2:return"Clientes";case 3:return"Productos"}return""}static#t=this.\u0275fac=function(a){return new(a||o)(t.Y36(b.D),t.Y36(y.x),t.Y36(Z.k),t.Y36(k.x),t.Y36(x.Z),t.Y36(L.$))};static#e=this.\u0275cmp=t.Xpm({type:o,selectors:[["app-appoint-list"]],viewQuery:function(a,i){if(1&a&&(t.Gf(M,5),t.Gf(U,5)),2&a){let n;t.iGM(n=t.CRH())&&(i.editControlTrigger=n.first),t.iGM(n=t.CRH())&&(i.chartTrigger=n.first)}},decls:69,vars:12,consts:[[1,"flex","flex-col","max-h-screen"],[3,"buttons","nav_menu","bar_text","onClicked"],["id","spanTrigger",3,"matMenuTriggerFor"],["editControlTrigger","matMenuTrigger"],["class","flex-1 m-2 bg-gray-100 overflow-scroll",3,"mousemove",4,"ngIf"],["class","flex-1 m-2 h-screen overflow-scroll",4,"ngIf"],["controlEdit","matMenu"],["mat-menu-item","",3,"matMenuTriggerFor"],["color","primary"],[1,"ml-1","mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-8"],["mat-menu-item","",3,"click"],[4,"ngIf"],[1,"ml-2","mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-5"],["mat-menu-item",""],["graphtype","matMenu"],["graphMenu","matMenu"],[1,"flex-1","m-2","bg-gray-100","overflow-scroll",3,"mousemove"],[1,"border","border-gray-200","rounded-sm","shadow-lg"],[3,"data","pivot","bartype","onSelect"],["id","chartTrigger",3,"matMenuTriggerFor"],["chartTrigger","matMenuTrigger"],[1,"flex-1","m-2","h-screen","overflow-scroll"],[3,"reset","markerlist","markerclick"]],template:function(a,i){if(1&a&&(t.TgZ(0,"div",0)(1,"app-header",1),t.NdJ("onClicked",function(l){return i.getClicked(l)}),t.qZA(),t._UZ(2,"span",2,3),t.YNc(4,G,5,4,"div",4),t.qZA(),t.YNc(5,J,2,2,"div",5),t.TgZ(6,"mat-menu",null,6)(8,"button",7)(9,"mat-icon",8),t._uU(10,"trending_up"),t.qZA(),t.TgZ(11,"span",9),t._uU(12),t.qZA()(),t.TgZ(13,"div",10)(14,"button",11),t.NdJ("click",function(){return i.onSelPivot(0)}),t.YNc(15,D,2,0,"mat-icon",12),t._uU(16," Tasker "),t.qZA(),t.TgZ(17,"button",11),t.NdJ("click",function(){return i.onSelPivot(1)}),t.YNc(18,S,2,0,"mat-icon",12),t._uU(19," Actividad "),t.qZA(),t.TgZ(20,"button",11),t.NdJ("click",function(){return i.onSelPivot(2)}),t.YNc(21,I,2,0,"mat-icon",12),t._uU(22," Cliente "),t.qZA(),t.TgZ(23,"button",11),t.NdJ("click",function(){return i.onSelPivot(3)}),t.YNc(24,E,2,0,"mat-icon",12),t._uU(25," Producto "),t.qZA()(),t._UZ(26,"hr"),t.TgZ(27,"h2",13)(28,"mat-icon"),t._uU(29,"file_download"),t.qZA(),t._uU(30,"\xa0Exportar"),t.qZA(),t.TgZ(31,"div",14)(32,"button",11),t.NdJ("click",function(){return i.onExportexcel()}),t._uU(33," Exportar Informe a Excel. "),t.qZA(),t.TgZ(34,"button",15),t._uU(35," Enviar Informe a Google Spread Sheet "),t.qZA()()(),t.TgZ(36,"mat-menu",null,16)(38,"button",11),t.NdJ("click",function(){return i.setGraphType(0)}),t._uU(39," Gr\xe1fica "),t.qZA(),t.TgZ(40,"button",11),t.NdJ("click",function(){return i.setGraphType(1)}),t._uU(41," Mapa "),t.qZA()(),t.TgZ(42,"mat-menu",null,17)(44,"button",11),t.NdJ("click",function(){return i.getGraphInfo(0)}),t.TgZ(45,"mat-icon"),t._uU(46,"task_alt"),t.qZA(),t._uU(47," Datos de la encuesta "),t.qZA(),t.TgZ(48,"button",11),t.NdJ("click",function(){return i.getGraphInfo(1)}),t.TgZ(49,"mat-icon"),t._uU(50,"perm_identity"),t.qZA(),t._uU(51," Datos del tasker "),t.qZA(),t.TgZ(52,"button",11),t.NdJ("click",function(){return i.getGraphInfo(2)}),t.TgZ(53,"mat-icon"),t._uU(54,"forum"),t.qZA(),t._uU(55," Conversar con el tasker "),t.qZA(),t.TgZ(56,"button",11),t.NdJ("click",function(){return i.getGraphInfo(3)}),t.TgZ(57,"mat-icon"),t._uU(58,"room"),t.qZA(),t._uU(59," Ubicaci\xf3n "),t.qZA(),t._UZ(60,"hr"),t.TgZ(61,"button",11),t.NdJ("click",function(){return i.getGraphInfo(4)}),t.TgZ(62,"mat-icon"),t._uU(63,"edit"),t.qZA(),t._uU(64," Editar Agenda "),t.qZA(),t.TgZ(65,"button",11),t.NdJ("click",function(){return i.getGraphInfo(5)}),t.TgZ(66,"mat-icon"),t._uU(67,"delete"),t.qZA(),t._uU(68," Borrar Agenda "),t.qZA()()),2&a){const n=t.MAs(7),l=t.MAs(37);t.xp6(1),t.Q6J("buttons","111111")("nav_menu",!1)("bar_text",i.bar_txt),t.xp6(1),t.Q6J("matMenuTriggerFor",n),t.xp6(2),t.Q6J("ngIf",0===i.bartype),t.xp6(1),t.Q6J("ngIf",1===i.bartype),t.xp6(3),t.Q6J("matMenuTriggerFor",l),t.xp6(4),t.Oqu(i.graphtypeName),t.xp6(3),t.Q6J("ngIf",0===i.pivot),t.xp6(3),t.Q6J("ngIf",1===i.pivot),t.xp6(3),t.Q6J("ngIf",2===i.pivot),t.xp6(3),t.Q6J("ngIf",3===i.pivot)}},dependencies:[_.O5,C.G,f.VK,f.OP,f.p6,v.Hw,F.g,N.G]})}return o})()}];let P=(()=>{class o{static#t=this.\u0275fac=function(a){return new(a||o)};static#e=this.\u0275mod=t.oAB({type:o});static#i=this.\u0275inj=t.cJS({imports:[g.Bz.forChild(q),g.Bz]})}return o})();var Q=s(769),Y=s(3279),w=s(6483),O=s(6965);let H=(()=>{class o{static#t=this.\u0275fac=function(a){return new(a||o)};static#e=this.\u0275mod=t.oAB({type:o});static#i=this.\u0275inj=t.cJS({imports:[_.ez,P,Q.O,Y.X,f.Tx,v.Ps,w.q,O.R]})}return o})()}}]);