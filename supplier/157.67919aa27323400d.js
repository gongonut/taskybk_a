"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[157],{6157:($,h,s)=>{s.r(h),s.d(h,{AppointListModule:()=>H});var _=s(7087),g=s(3759),p=s(3241),t=s(2283),y=s(4758),b=s(4537),Z=s(6806),x=s(7883),k=s(1682),L=s(8035),C=s(3578),f=s(9347),v=s(8464),F=s(9554),N=s(5802);const M=["editControlTrigger"],G=["chartTrigger"];function J(o,u){if(1&o){const e=t.EpF();t.TgZ(0,"div",18),t.NdJ("mousemove",function(i){t.CHM(e);const a=t.oxw();return t.KtG(a.mousepos(i))}),t.TgZ(1,"div",19)(2,"app-time-line",20),t.NdJ("onSelect",function(i){t.CHM(e);const a=t.oxw();return t.KtG(a.onSelect(i))}),t.qZA()(),t._UZ(3,"span",21,22),t.qZA()}if(2&o){const e=t.oxw(),n=t.MAs(43);t.xp6(2),t.Q6J("data",e.dataList)("pivot",e.pivot)("bartype",e.bartype),t.xp6(1),t.Q6J("matMenuTriggerFor",n)}}function D(o,u){if(1&o){const e=t.EpF();t.TgZ(0,"div",23)(1,"app-map",24),t.NdJ("markerclick",function(i){t.CHM(e);const a=t.oxw();return t.KtG(a.getMarkerClicked(i))}),t.qZA()()}if(2&o){const e=t.oxw();t.xp6(1),t.Q6J("reset",e.reset)("markerlist",e.dataList)}}function S(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function U(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function E(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function I(o,u){1&o&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}const P=[{path:"",component:(()=>{class o{constructor(e,n,i,a,r,d){this.sharedvar=e,this.staffServ=n,this.dtb=i,this.dg=a,this.data2excel=r,this.notif=d,this.staffList=[],this.pivot=0,this.bartype=0,this.chunk="D",this.graphtypeName="Linea de tiempo apilado",this.mpos={x:-1,y:-1},this.bar_txt="",this.reset=0}ngOnInit(){var e=this;return(0,p.Z)(function*(){e.staffSub=e.notif.getStaffNotif_Obs().subscribe({next:r=>{e.executeFilter()}}),e.staffList=yield e.dtb.getStaffByFilterAsync({queryType:1,active:!0,stars:0,rol:"P"}),e.staffServ.startAppointData(e.staffList);const n=new Date,i=n.setHours(0,0,0,0),a=n.setHours(23,59,59,999);e.localFilter={crm:"T",staff__id:[],pollGrpData:[],costumers:[],products:[],products_name_sel:[],date_ini:i,date_end:a},e.executeFilter()})()}ngOnDestroy(){this.staffSub&&this.staffSub.unsubscribe()}setGraphType(e){switch(this.bartype=e,e){case 0:this.graphtypeName="Linea de tiempo apilado";break;case 1:this.graphtypeName="Mapa"}}executeFilter(){this.localFilter&&(this.dataList=[],this.getTitleText(),this.staffList.forEach(e=>{if(e.appoint&&(0===this.localFilter.staff__id.length||-1!==this.localFilter.staff__id.findIndex(n=>e._id===n))){for(let n=0;n<e.appoint.length;n++){const i=e.appoint[n];let a=!i.ended;a=!(!a||!(0===this.localFilter.pollGrpData.length||this.localFilter.pollGrpData.findIndex(r=>r===i.pollgrp_id)>-1)),a=!(!a||!(0===this.localFilter.costumers.length||this.localFilter.costumers.findIndex(r=>r===i.costumer)>-1)),a=!!(a&&this.localFilter.date_ini<=i.datetime&&i.datetime<=this.localFilter.date_end),a&&this.dataList.push(this.staffServ.staff2analitic(n,e,i))}this.dataList.sort((n,i)=>Number(i.date_ini)-Number(n.date_ini))}}))}getClicked(e){var n=this;return(0,p.Z)(function*(){switch(e.index){case 1:n.filterDialog();break;case 2:n.addAppoint();break;case 3:let i=document.getElementById("spanTrigger");i&&(i.style.display="",i.style.position="absolute",i.style.left=e.pageX+5+"px",i.style.top=e.pageY+5+"px",n.editControlTrigger.openMenu());break;case 4:yield n.executeFilter()}})()}addAppoint(){this.staffServ.onAddEditAppoint(null,-1)}getTitleText(){this.localFilter&&(this.bar_txt="",this.localFilter.pollGrpData&&this.localFilter.pollGrpData.length>0&&(this.bar_txt+="Modelos - "),this.localFilter.staff__id&&this.localFilter.staff__id.length>0&&(this.bar_txt+="Tasker - "),this.localFilter.costumers&&this.localFilter.costumers.length>0&&(this.bar_txt+="Clientes - "),this.localFilter.products&&this.localFilter.products.length>0&&(this.bar_txt+="Productos - "),this.bar_txt+=`Fecha desde ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"/")}\n     hasta ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"/")}`)}getMarkerClicked(e){var n=this;return(0,p.Z)(function*(){const i=e.target.options.alt.split(":"),a=n.staffList.find(r=>r._id===i[0]);if(a){if("click"===e.type)n.staffServ.onAddEditAppoint(a,Number(i[1]),!1);else if("moveend"===e.type){const r=e.target._latlng.lat,d=e.target._latlng.lng;a.appoint[Number(i[1])].geoLoc={lat:r,lng:d},n.dtb.updateStaffAsync(a)}n.reset++}})()}filterDialog(){var e=this;return(0,p.Z)(function*(){e.sharedvar.wait=!0;let n=[],i=[],a=[],r=[];(yield e.dtb.getStaffByFilterAsync({queryType:3,active:!0,stars:0,rol:"K"})).forEach(c=>{n.push({key:c._id,value:`${c.names||c.email} ${c.lastnames||""}`})}),(yield e.dtb.getPollGrpActiveAsync()).forEach(c=>{"index"!==c.id&&i.push({key:c._id,value:c.name})}),(yield e.dtb.getActiveCRMCostumAsync()).forEach(c=>{a.push({key:c.id,value:c.name})}),(yield e.dtb.getAllCRMProdAsync()).forEach(c=>{r.push({key:c.id,value:c.name})}),e.dg.aDefault({schema:{controls:[{name:"staff__id",label:"Taskers:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:n},{name:"pollGrpData",label:"Modelos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:i},{name:"costumers",label:"Clientes:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:a},{name:"products",label:"Productos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:r},{name:"date_ini",label:"Fecha inicio:",type:"date",validators:{}},{name:"date_end",label:"Fecha final:",type:"date",validators:{}}]},title:"Filtros",dgheigth:615,dgwidth:550,value:e.localFilter}).subscribe(function(){var c=(0,p.Z)(function*(l){if(e.sharedvar.wait=!1,l){if(l.alldates)l.date_ini=0,l.date_end=0;else{let m=new Date(l.date_ini||0);l.date_ini=m.setHours(0,0,0,0),m=new Date(l.date_end||0),l.date_end=m.setHours(23,59,59,999)}const T=[];l.products&&l.products.length>0&&l.products.forEach(m=>{const A=r.find(R=>R.key===m);A&&T.push(A.value)}),e.localFilter={crm:"T",staff__id:l.staff__id,pollGrpData:l.pollGrpData,costumers:l.costumers,products:l.products,date_ini:l.date_ini,date_end:l.date_end,products_name_sel:[...T]},yield e.executeFilter()}});return function(l){return c.apply(this,arguments)}}())})()}mousepos(e){this.mpos.x=e.clientX,this.mpos.y=e.clientY}onSelect(e){var n=this;return(0,p.Z)(function*(){let i=document.getElementById("chartTrigger");i&&(n.graphevent=e,i.style.display="",i.style.position="absolute",i.style.left=n.mpos.x+5+"px",i.style.top=n.mpos.y+5+"px",n.chartTrigger.openMenu())})()}getGraphInfo(e){var n=this;return(0,p.Z)(function*(){const i=n.graphevent.meta.split(":"),a=n.staffList.find(d=>d._id===i[0]);if(a?.appoint&&a.appoint[Number(i[1])])switch(e){case 1:case 2:break;case 4:n.staffServ.onAddEditAppoint(a,Number(i[1]));break;case 5:n.staffServ.onDelAppoint(a,Number(i[1]))}})()}onExportexcel(){const e=`Reporte CRM fechas ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"-")} - \n    ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"-")}`;this.data2excel.excelExport(this.dataList,e,"CRM",this.header,[])}onSelPivot(e){this.pivot=e}getPivotName(){switch(this.pivot){case 0:return"Tasker";case 1:return"Actividades";case 2:return"Clientes";case 3:return"Productos"}return""}static#t=this.\u0275fac=function(n){return new(n||o)(t.Y36(y.D),t.Y36(b.x),t.Y36(Z.k),t.Y36(x.x),t.Y36(k.Z),t.Y36(L.$))};static#e=this.\u0275cmp=t.Xpm({type:o,selectors:[["app-appoint-list"]],viewQuery:function(n,i){if(1&n&&(t.Gf(M,5),t.Gf(G,5)),2&n){let a;t.iGM(a=t.CRH())&&(i.editControlTrigger=a.first),t.iGM(a=t.CRH())&&(i.chartTrigger=a.first)}},decls:61,vars:12,consts:[[1,"flex","flex-col","max-h-screen"],[3,"buttons","nav_menu","bar_text","onClicked"],["id","spanTrigger",3,"matMenuTriggerFor"],["editControlTrigger","matMenuTrigger"],["class","flex-1 m-2 bg-gray-100 overflow-scroll",3,"mousemove",4,"ngIf"],["class","flex-1 m-2 h-screen overflow-scroll",4,"ngIf"],["controlEdit","matMenu"],["mat-menu-item","",3,"matMenuTriggerFor"],["color","primary"],[1,"ml-1","mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-8"],["mat-menu-item","",3,"click"],[4,"ngIf"],[1,"ml-2","mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-5"],["mat-menu-item",""],["graphtype","matMenu"],["graphMenu","matMenu"],[1,"flex-1","m-2","bg-gray-100","overflow-scroll",3,"mousemove"],[1,"border","border-gray-200","rounded-sm","shadow-lg"],[3,"data","pivot","bartype","onSelect"],["id","chartTrigger",3,"matMenuTriggerFor"],["chartTrigger","matMenuTrigger"],[1,"flex-1","m-2","h-screen","overflow-scroll"],[3,"reset","markerlist","markerclick"]],template:function(n,i){if(1&n&&(t.TgZ(0,"div",0)(1,"app-header",1),t.NdJ("onClicked",function(r){return i.getClicked(r)}),t.qZA(),t._UZ(2,"span",2,3),t.YNc(4,J,5,4,"div",4),t.qZA(),t.YNc(5,D,2,2,"div",5),t.TgZ(6,"mat-menu",null,6)(8,"button",7)(9,"mat-icon",8),t._uU(10,"trending_up"),t.qZA(),t.TgZ(11,"span",9),t._uU(12),t.qZA()(),t.TgZ(13,"div",10)(14,"button",11),t.NdJ("click",function(){return i.onSelPivot(0)}),t.YNc(15,S,2,0,"mat-icon",12),t._uU(16," Tasker "),t.qZA(),t.TgZ(17,"button",11),t.NdJ("click",function(){return i.onSelPivot(1)}),t.YNc(18,U,2,0,"mat-icon",12),t._uU(19," Actividad "),t.qZA(),t.TgZ(20,"button",11),t.NdJ("click",function(){return i.onSelPivot(2)}),t.YNc(21,E,2,0,"mat-icon",12),t._uU(22," Cliente "),t.qZA(),t.TgZ(23,"button",11),t.NdJ("click",function(){return i.onSelPivot(3)}),t.YNc(24,I,2,0,"mat-icon",12),t._uU(25," Producto "),t.qZA()(),t._UZ(26,"hr"),t.TgZ(27,"h2",13)(28,"mat-icon"),t._uU(29,"file_download"),t.qZA(),t._uU(30,"\xa0Exportar"),t.qZA(),t.TgZ(31,"div",14)(32,"button",11),t.NdJ("click",function(){return i.onExportexcel()}),t._uU(33," Exportar Informe a Excel. "),t.qZA(),t.TgZ(34,"button",15),t._uU(35," Enviar Informe a Google Spread Sheet "),t.qZA()()(),t.TgZ(36,"mat-menu",null,16)(38,"button",11),t.NdJ("click",function(){return i.setGraphType(0)}),t._uU(39," Gr\xe1fica "),t.qZA(),t.TgZ(40,"button",11),t.NdJ("click",function(){return i.setGraphType(1)}),t._uU(41," Mapa "),t.qZA()(),t.TgZ(42,"mat-menu",null,17)(44,"button",11),t.NdJ("click",function(){return i.getGraphInfo(1)}),t.TgZ(45,"mat-icon"),t._uU(46,"perm_identity"),t.qZA(),t._uU(47," Datos del tasker "),t.qZA(),t.TgZ(48,"button",11),t.NdJ("click",function(){return i.getGraphInfo(2)}),t.TgZ(49,"mat-icon"),t._uU(50,"forum"),t.qZA(),t._uU(51," Conversar con el tasker "),t.qZA(),t._UZ(52,"hr"),t.TgZ(53,"button",11),t.NdJ("click",function(){return i.getGraphInfo(4)}),t.TgZ(54,"mat-icon"),t._uU(55,"edit"),t.qZA(),t._uU(56," Editar Agenda "),t.qZA(),t.TgZ(57,"button",11),t.NdJ("click",function(){return i.getGraphInfo(5)}),t.TgZ(58,"mat-icon"),t._uU(59,"delete"),t.qZA(),t._uU(60," Borrar Agenda "),t.qZA()()),2&n){const a=t.MAs(7),r=t.MAs(37);t.xp6(1),t.Q6J("buttons","111111")("nav_menu",!1)("bar_text",i.bar_txt),t.xp6(1),t.Q6J("matMenuTriggerFor",a),t.xp6(2),t.Q6J("ngIf",0===i.bartype),t.xp6(1),t.Q6J("ngIf",1===i.bartype),t.xp6(3),t.Q6J("matMenuTriggerFor",r),t.xp6(4),t.Oqu(i.graphtypeName),t.xp6(3),t.Q6J("ngIf",0===i.pivot),t.xp6(3),t.Q6J("ngIf",1===i.pivot),t.xp6(3),t.Q6J("ngIf",2===i.pivot),t.xp6(3),t.Q6J("ngIf",3===i.pivot)}},dependencies:[_.O5,C.G,f.VK,f.OP,f.p6,v.Hw,F.g,N.G]})}return o})()}];let Q=(()=>{class o{static#t=this.\u0275fac=function(n){return new(n||o)};static#e=this.\u0275mod=t.oAB({type:o});static#i=this.\u0275inj=t.cJS({imports:[g.Bz.forChild(P),g.Bz]})}return o})();var Y=s(769),q=s(3279),w=s(6483),O=s(6965);let H=(()=>{class o{static#t=this.\u0275fac=function(n){return new(n||o)};static#e=this.\u0275mod=t.oAB({type:o});static#i=this.\u0275inj=t.cJS({imports:[_.ez,Q,Y.O,q.X,f.Tx,v.Ps,w.q,O.R]})}return o})()}}]);