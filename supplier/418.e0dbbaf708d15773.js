"use strict";(self.webpackChunktasky_supplier=self.webpackChunktasky_supplier||[]).push([[418],{4418:(nt,C,u)=>{u.r(C),u.d(C,{TaskReportModule:()=>at});var T=u(4070),v=u(781),m=u(3241),t=u(6339),M=u(6789),x=u(3016),F=u(3792),R=u(5888),Z=u(7254),U=u(2615),L=u(1791),N=u(6848),J=u(5180),Y=u(9869),y=u(4156),A=u(8137),w=u(1292),b=u(7142);const P=["chart"];function E(i,f){if(1&i&&(t.TgZ(0,"div",1),t._UZ(1,"apx-chart",2),t.qZA()),2&i){const a=t.oxw();t.xp6(1),t.Q6J("series",a.chartOptions.series)("chart",a.chartOptions.chart)("dataLabels",a.chartOptions.dataLabels)("plotOptions",a.chartOptions.plotOptions)("responsive",a.chartOptions.responsive)("xaxis",a.chartOptions.xaxis)("legend",a.chartOptions.legend)("fill",a.chartOptions.fill)}}let D=(()=>{class i{constructor(){this.data=[],this.prod_list=[],this.pivot=0,this.bartype=0,this.chunk="M",this.onSelect=new t.vpe,this.sliceChunk=[]}ngOnChanges(a){this.data&&this.data.length>0&&(this.setChunkList(),this.buildChart())}buildChart(){var a=this;return(0,m.Z)(function*(){switch(a.pivot){case 0:a.getDataTaskCostumerChunk(a.sliceChunk,"T");break;case 1:a.getDataTaskCostumerChunk(a.sliceChunk,"A");break;case 2:a.getDataTaskCostumerChunk(a.sliceChunk,"C");break;case 3:a.timeLineProductPivot(a.sliceChunk)}a.chartOptions={series:a.serieList,chart:{type:"bar",height:350,stacked:!0,stackType:"100%",toolbar:{show:!0,tools:{pan:!0,zoomin:!0,zoomout:!0}}},responsive:[{breakpoint:480,options:{legend:{position:"bottom",offsetX:-10,offsetY:0}}}],xaxis:{categories:a.categ},fill:{opacity:1},legend:{position:"top",horizontalAlign:"left",offsetX:0,offsetY:10}}})()}setChunkList(){let a=this.getChunkSlice(this.data[0].date_ini).firstDay;const s=this.getChunkSlice(this.data[this.data.length-1].date_end).lastDay;for(this.sliceChunk=[];a<s;)this.sliceChunk.push(this.getChunkSlice(a)),a=this.getChunkNextDate(this.sliceChunk[this.sliceChunk.length-1].lastDay)}getChunkSlice(a){let s;const e=new Date(a);switch(this.chunk){case"D":const n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0).getTime(),o=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23).getTime();return s=`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`,{firstDay:n,lastDay:o,name:s};case"M":const r=new Date(e.getFullYear(),e.getMonth(),1,0).getTime(),c=new Date(e.getFullYear(),e.getMonth()+1,0,23).getTime();return s=`${e.getMonth()+1}/${e.getFullYear()}`,{firstDay:r,lastDay:c,name:s};case"Y":const l=e.getFullYear();return s=l.toString(),{firstDay:new Date(l,0,1,0).getTime(),lastDay:new Date(l,11,31,23).getTime(),name:s}}return{firstDay:0,lastDay:0,name:"ni idea"}}getChunkNextDate(a){const s=new Date(a);switch(this.chunk){case"D":return new Date(s.getFullYear(),s.getMonth(),s.getDate()+1,0).getTime();case"M":return new Date(s.getFullYear(),s.getMonth()+1,s.getDate(),0).getTime();case"Y":return new Date(s.getFullYear()+1,0,1,0).getTime()}return 0}getDataTaskCostumerChunk(a,s){let e=[];this.serieList=[];let n=[];this.data.forEach(l=>{let d="";switch(s){case"T":d=l.tasker_name;break;case"A":d=l.activity_name;break;case"C":d=l.costumer_name}e.push(d)}),e=[...new Set(e)],e.forEach(l=>{l&&(n.push({key:l,value:0}),this.serieList.push({name:l,data:[]}))}),e=[],this.categ=[],n.forEach(l=>l.value=0);let c,o=0,r=0;for(;r<this.data.length;){if(!(o<a.length))return;for(c=a[o],this.categ.push(c.name),o++;r<this.data.length&&this.data[r].date_ini>=c.firstDay&&this.data[r].date_end<=c.lastDay;r++){const l=n.find(d=>{switch(s){case"T":return d.key===this.data[r].tasker_name;case"A":return d.key===this.data[r].activity_name;case"C":return d.key===this.data[r].costumer_name}return null});l&&l.value++}this.serieList.forEach(l=>{const d=n.find(_=>_.key===l.name);d&&l.data.push(d.value)})}}timeLineProductPivot(a){(!this.prod_list||0===this.prod_list.length)&&(this.prod_list=[],this.data.forEach(c=>{c.crm_products&&c.crm_products.length>0&&this.prod_list.push(...c.crm_products)}));let s=[...new Set(this.prod_list)];this.serieList=[];let e=[];s.forEach(c=>{c&&(e.push({key:c,value:0}),this.serieList.push({name:c,data:[]}))}),s=[],this.categ=[];let r,n=0,o=0;for(e.forEach(c=>c.value=0);o<this.data.length;){if(!(n<a.length))return;for(r=a[n],this.categ.push(r.name),n++;o<this.data.length&&this.data[o].date_ini>=r.firstDay&&this.data[o].date_end<=r.lastDay;o++)e.forEach(c=>{this.data[o].crm_products.find(d=>d===c.key)&&c.value++});this.serieList.forEach(c=>{const l=e.find(d=>d.key===c.name);l&&c.data.push(l.value)})}}static#t=this.\u0275fac=function(s){return new(s||i)};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["app-stack-col-ptj"]],viewQuery:function(s,e){if(1&s&&t.Gf(P,5),2&s){let n;t.iGM(n=t.CRH())&&(e.chart=n.first)}},inputs:{data:"data",prod_list:"prod_list",pivot:"pivot",bartype:"bartype",chunk:"chunk"},outputs:{onSelect:"onSelect"},features:[t.TTD],decls:1,vars:1,consts:[["id","chart",4,"ngIf"],["id","chart"],[3,"series","chart","dataLabels","plotOptions","responsive","xaxis","legend","fill"]],template:function(s,e){1&s&&t.YNc(0,E,2,8,"div",0),2&s&&t.Q6J("ngIf",e.data&&e.data.length>0)},dependencies:[T.O5,b.x]})}return i})();const G=["editControlTrigger"],I=["chartTrigger"];function O(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function q(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function j(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function Q(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function B(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function $(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}function z(i,f){1&i&&(t.TgZ(0,"mat-icon"),t._uU(1,"done"),t.qZA())}const H=[{path:"",component:(()=>{class i{constructor(a,s,e,n,o,r,c,l,d){this.sharedvar=a,this.dtb=s,this.dg=e,this.data2excel=n,this.snkBar=o,this.notif=r,this.staffServ=c,this.chats=l,this.prodserv=d,this.pivot=0,this.bartype=1,this.chunk="D",this.graphtypeName="Linea de tiempo apilado",this.mpos={x:-1,y:-1}}ngOnInit(){var a=this;return(0,m.Z)(function*(){const s=new Date,e=s.setHours(0,0,0,0),n=s.setHours(23,59,59,999);var o;a.localFilter={crm:"T",staff__id:[],pollGrpData:[],costumers:[],products:[],products_name_sel:[],date_all:!1,date_ini:e,date_end:n},yield a.executeFilter(),a.resultSub=a.notif.getNotif_obs().subscribe({next:(o=(0,m.Z)(function*(r){switch(r.mycollection){case"pollresult":(a.dataList.find(g=>g._id===r.field_id)||"delete"===r.dbState||"update"===r.dbState)&&a.snkBar.open("Hay novedades en el informe. Desea actualizar la vista","Si",{duration:5e3}).onAction().subscribe(g=>{a.executeFilter()});break;case"ansgeoloc":if(!r.data)return;const l=[a.dataList.find(g=>g._id===r.data.appoint_id)];if(!l)return;l[0].geoLocStart=r.data.geoloc;const d={title:"Geo localizaci\xf3n",dgheigth:600,value:l};yield a.dg.aMap(d)}}),function(c){return o.apply(this,arguments)})})})()}ngOnDestroy(){this.resultSub&&this.resultSub.unsubscribe()}executeFilter(){var a=this;return(0,m.Z)(function*(){yield a.dtb.getPollGrpAnaliticAsync(a.localFilter).then(s=>{a.dataList=s.data,a.header=s.header})})()}getClicked(a){var s=this;return(0,m.Z)(function*(){switch(a.index){case 1:s.filterDialog();break;case 3:let e=document.getElementById("spanTrigger");e&&(e.style.display="",e.style.position="absolute",e.style.left=a.pageX+5+"px",e.style.top=a.pageY+5+"px",s.editControlTrigger.openMenu());break;case 4:yield s.executeFilter()}})()}getTitleText(){return`${this.graphtypeName} - ${this.getPivotName()} - Porcentaje por ${this.getTimechunk()} ... Fecha desde: ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"/")}\n    hasta: ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"/")}`}filterDialog(){var a=this;return(0,m.Z)(function*(){a.sharedvar.wait=!0;let s=[],e=[],n=[],o=[];(yield a.dtb.getStaffByFilterAsync({queryType:3,active:!0,stars:0,rol:"K"})).forEach(h=>{s.push({key:h._id,value:`${h.names||h.email} ${h.lastnames||""}`})}),(yield a.dtb.getPollGrpActiveAsync()).forEach(h=>{"index"!==h.id&&e.push({key:h._id,value:h.name})}),(yield a.dtb.getActiveCRMCostumAsync()).forEach(h=>{n.push({key:h.id,value:h.name})}),(yield a.prodserv.getAllCRMProdAsync("parent")).forEach(h=>{o.push({key:h.id,value:h.name})});let g={schema:{controls:[{name:"staff__id",label:"Taskers:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:s},{name:"pollGrpData",label:"Formularios:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:e},{name:"costumers",label:"Clientes:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:n},{name:"products",label:"Productos:",type:"multiselect",placeholder:"Todos",style:"w-full",validators:{},selectOptions:o},{name:"date_ini",label:"Fecha inicio:",type:"date",validators:{}},{name:"date_end",label:"Fecha final:",type:"date",validators:{}}]},title:"Filtros",dgheigth:615,dgwidth:550,value:a.localFilter};const p=yield a.dg.aDefault(g);if(a.sharedvar.wait=!1,p){if(p.alldates)p.date_ini=0,p.date_end=0;else{let k=new Date(p.date_ini||0);p.date_ini=k.setHours(0,0,0,0),k=new Date(p.date_end||0),p.date_end=k.setHours(23,59,59,999)}const h=[];p.products&&p.products.length>0&&p.products.forEach(k=>{const S=o.find(st=>st.key===k);S&&h.push(S.value)}),a.localFilter={crm:"T",staff__id:p.staff__id,pollGrpData:p.pollGrpData,costumers:p.costumers,products:p.products,date_all:!1,date_ini:p.date_ini,date_end:p.date_end,products_name_sel:[...h]},yield a.executeFilter()}})()}mousepos(a){this.mpos.x=a.clientX,this.mpos.y=a.clientY}onSelect(a){var s=this;return(0,m.Z)(function*(){let e=document.getElementById("chartTrigger");e&&(s.graphevent=a,e.style.display="",e.style.position="absolute",e.style.left=s.mpos.x+5+"px",e.style.top=s.mpos.y+5+"px",s.chartTrigger.openMenu())})()}getGraphInfo(a){var s=this;return(0,m.Z)(function*(){const e=yield s.dtb.getPollResultAsync(s.graphevent.meta);switch(a){case 0:2===e.status&&s.snkBar.open("La encuesta est\xe1 en proceso, los datos pueden no estar actualizados","Ok",{duration:3e3});let n={schema:{},value:e,title:"Datos de la encuesta"};yield s.dg.aPollResult(n);break;case 1:e.staff__id&&s.onGetTaskInfo(e.staff__id);break;case 2:s.notif.sendCommand({cmd:"geoloc",user_id:s.sharedvar.staff._id,usert_id:e.staff__id,data:{appoint_id:e._id}});break;case 3:if(e.status>2)return void s.snkBar.open("Ya finaliz\xf3 la encuesta, desea enviar un mensaje?","Enviar mensaje",{duration:8e3}).onAction().subscribe(r=>{s.staffServ.onMessage2(e.staff_name,e.staff__id)});s.onPollChat(e)}})()}onPollChat(a){var s=this;return(0,m.Z)(function*(){a&&(yield s.dtb.getStaffById(a.staff__id),s.selChat=a,s.chats.chatExec(`tasker ${s.selChat.staff_name}`,s.selChat.chats||[],s.adminChat,s))})()}adminChat(a,s,e){a.selChat.chats=s,a.dtb.updatePartialAsync(a.selChat,"chats",a.selChat.staff__id),a.selResultId=""}onExportexcel(){const a=`Reporte CRM fechas ${this.sharedvar.formatNumber2Date(this.localFilter.date_ini||0,"-")} - \n    ${this.sharedvar.formatNumber2Date(this.localFilter.date_end||0,"-")}`;this.data2excel.excelExport(this.dataList,a,"CRM",this.header,[])}onSelPivot(a){this.pivot=a}getPivotName(){switch(this.pivot){case 0:return"Tasker";case 1:return"Actividades";case 2:return"Clientes";case 3:return"Productos"}return""}setGraphType(a){switch(this.bartype=a,a){case 0:this.graphtypeName="Linea de tiempo discriminado";break;case 1:this.graphtypeName="Linea de tiempo apilado";break;case 2:this.graphtypeName="Barra de porcentaje"}}setTimechunk(a){this.chunk=a}getTimechunk(){switch(this.chunk){case"D":return"d\xedas";case"M":return"meses";case"Y":return"a\xf1os"}return""}onGetTaskInfo(a){var s=this;return(0,m.Z)(function*(){const e=yield s.dtb.getStaffById(a);s.dg.aObject2Table({title:`Datos de ${e.names||""} ${e.lastnames||""}`,dgheigth:615,dgwidth:550,value:e,tags:{metadata:s.staffServ.taskerData}})})()}static#t=this.\u0275fac=function(s){return new(s||i)(t.Y36(M.D),t.Y36(x.k),t.Y36(F.x),t.Y36(R.Z),t.Y36(Z.ux),t.Y36(U.$),t.Y36(L.x),t.Y36(N.a),t.Y36(J.M))};static#e=this.\u0275cmp=t.Xpm({type:i,selectors:[["app-task-report"]],viewQuery:function(s,e){if(1&s&&(t.Gf(G,5),t.Gf(I,5)),2&s){let n;t.iGM(n=t.CRH())&&(e.editControlTrigger=n.first),t.iGM(n=t.CRH())&&(e.chartTrigger=n.first)}},decls:87,vars:23,consts:[[1,"flex","flex-col","max-h-screen"],[3,"buttons","nav_menu","bar_text","onClicked"],["id","spanTrigger",3,"matMenuTriggerFor"],["editControlTrigger","matMenuTrigger"],[1,"flex-1","m-2","bg-gray-100","overflow-scroll",3,"mousemove"],[1,"border","border-gray-200","rounded-sm","shadow-lg"],[3,"data","prod_list","pivot","bartype","onSelect"],[3,"data","prod_list","pivot","bartype","chunk","onSelect"],["id","chartTrigger",3,"matMenuTriggerFor"],["chartTrigger","matMenuTrigger"],["controlEdit","matMenu"],["mat-menu-item","",3,"matMenuTriggerFor"],["color","primary"],[1,"mt-1","text-violet-500","text-lg","font-medium"],[1,"ml-3"],["mat-menu-item","",3,"click"],[4,"ngIf"],["mat-menu-item",""],[1,"ml-1","mt-1","text-violet-500","text-lg","font-medium"],["graphtype","matMenu"],["graphMenu","matMenu"]],template:function(s,e){if(1&s&&(t.TgZ(0,"div",0)(1,"app-header",1),t.NdJ("onClicked",function(o){return e.getClicked(o)}),t.qZA(),t._UZ(2,"span",2,3),t.TgZ(4,"div",4),t.NdJ("mousemove",function(o){return e.mousepos(o)}),t.TgZ(5,"div",5)(6,"app-time-line",6),t.NdJ("onSelect",function(o){return e.onSelect(o)}),t.qZA()(),t.TgZ(7,"div",5)(8,"app-stack-col-ptj",7),t.NdJ("onSelect",function(o){return e.onSelect(o)}),t.qZA()(),t._UZ(9,"span",8,9),t.qZA()(),t.TgZ(11,"mat-menu",null,10)(13,"button",11)(14,"mat-icon",12),t._uU(15,"trending_up"),t.qZA(),t.TgZ(16,"span",13),t._uU(17),t.qZA()(),t.TgZ(18,"div",14)(19,"button",15),t.NdJ("click",function(){return e.onSelPivot(0)}),t.YNc(20,O,2,0,"mat-icon",16),t._uU(21," Tasker "),t.qZA(),t.TgZ(22,"button",15),t.NdJ("click",function(){return e.onSelPivot(1)}),t.YNc(23,q,2,0,"mat-icon",16),t._uU(24," Actividad "),t.qZA(),t.TgZ(25,"button",15),t.NdJ("click",function(){return e.onSelPivot(2)}),t.YNc(26,j,2,0,"mat-icon",16),t._uU(27," Cliente "),t.qZA(),t.TgZ(28,"button",15),t.NdJ("click",function(){return e.onSelPivot(3)}),t.YNc(29,Q,2,0,"mat-icon",16),t._uU(30," Producto "),t.qZA()(),t._UZ(31,"hr"),t.TgZ(32,"h2",13)(33,"mat-icon"),t._uU(34,"percent"),t.qZA(),t._uU(35,"\xa0Porcentajes por:"),t.qZA(),t.TgZ(36,"button",15),t.NdJ("click",function(){return e.setTimechunk("D")}),t.YNc(37,B,2,0,"mat-icon",16),t._uU(38," D\xedas "),t.qZA(),t.TgZ(39,"button",15),t.NdJ("click",function(){return e.setTimechunk("M")}),t.YNc(40,$,2,0,"mat-icon",16),t._uU(41," Meses "),t.qZA(),t.TgZ(42,"button",15),t.NdJ("click",function(){return e.setTimechunk("Y")}),t.YNc(43,z,2,0,"mat-icon",16),t._uU(44," A\xf1os "),t.qZA(),t._UZ(45,"hr"),t.TgZ(46,"h2",13)(47,"mat-icon"),t._uU(48,"trending_up"),t.qZA(),t._uU(49,"\xa0Inteligencia Artificial "),t.qZA(),t.TgZ(50,"div")(51,"button",17),t._uU(52," An\xe1lisis con soporte de IA "),t.qZA()(),t._UZ(53,"hr"),t.TgZ(54,"h2",18)(55,"mat-icon"),t._uU(56,"file_download"),t.qZA(),t._uU(57,"\xa0Exportar"),t.qZA(),t.TgZ(58,"div",14)(59,"button",15),t.NdJ("click",function(){return e.onExportexcel()}),t._uU(60," Exportar Informe a Excel. "),t.qZA(),t.TgZ(61,"button",17),t._uU(62," Enviar Informe a Google Spread Sheet "),t.qZA()()(),t.TgZ(63,"mat-menu",null,19)(65,"button",15),t.NdJ("click",function(){return e.setGraphType(0)}),t._uU(66," Linea de tiempo discriminado "),t.qZA(),t.TgZ(67,"button",15),t.NdJ("click",function(){return e.setGraphType(1)}),t._uU(68," Linea de tiempo apilado "),t.qZA()(),t.TgZ(69,"mat-menu",null,20)(71,"button",15),t.NdJ("click",function(){return e.getGraphInfo(0)}),t.TgZ(72,"mat-icon"),t._uU(73,"task_alt"),t.qZA(),t._uU(74," Datos de la encuesta "),t.qZA(),t.TgZ(75,"button",15),t.NdJ("click",function(){return e.getGraphInfo(1)}),t.TgZ(76,"mat-icon"),t._uU(77,"perm_identity"),t.qZA(),t._uU(78," Datos del tasker "),t.qZA(),t.TgZ(79,"button",15),t.NdJ("click",function(){return e.getGraphInfo(2)}),t.TgZ(80,"mat-icon"),t._uU(81,"room"),t.qZA(),t._uU(82," Ubicaci\xf3n actual "),t.qZA(),t.TgZ(83,"button",15),t.NdJ("click",function(){return e.getGraphInfo(3)}),t.TgZ(84,"mat-icon"),t._uU(85,"forum"),t.qZA(),t._uU(86," Conversar con el tasker "),t.qZA()()),2&s){const n=t.MAs(12),o=t.MAs(64),r=t.MAs(70);t.xp6(1),t.Q6J("buttons","110111")("nav_menu",!1)("bar_text",e.getTitleText()),t.xp6(1),t.Q6J("matMenuTriggerFor",n),t.xp6(4),t.Q6J("data",e.dataList)("prod_list",e.localFilter.products_name_sel)("pivot",e.pivot)("bartype",e.bartype),t.xp6(2),t.Q6J("data",e.dataList)("prod_list",e.localFilter.products_name_sel)("pivot",e.pivot)("bartype",e.bartype)("chunk",e.chunk),t.xp6(1),t.Q6J("matMenuTriggerFor",r),t.xp6(4),t.Q6J("matMenuTriggerFor",o),t.xp6(4),t.Oqu(e.graphtypeName),t.xp6(3),t.Q6J("ngIf",0===e.pivot),t.xp6(3),t.Q6J("ngIf",1===e.pivot),t.xp6(3),t.Q6J("ngIf",2===e.pivot),t.xp6(3),t.Q6J("ngIf",3===e.pivot),t.xp6(8),t.Q6J("ngIf","D"===e.chunk),t.xp6(3),t.Q6J("ngIf","M"===e.chunk),t.xp6(3),t.Q6J("ngIf","Y"===e.chunk)}},dependencies:[T.O5,Y.G,y.VK,y.OP,y.p6,A.Hw,w.g,D]})}return i})()}];let X=(()=>{class i{static#t=this.\u0275fac=function(s){return new(s||i)};static#e=this.\u0275mod=t.oAB({type:i});static#a=this.\u0275inj=t.cJS({imports:[v.Bz.forChild(H),v.Bz]})}return i})();var K=u(5425),V=u(1270);const W=[{path:"",component:D}];let tt=(()=>{class i{static#t=this.\u0275fac=function(s){return new(s||i)};static#e=this.\u0275mod=t.oAB({type:i});static#a=this.\u0275inj=t.cJS({imports:[v.Bz.forChild(W),v.Bz]})}return i})(),et=(()=>{class i{static#t=this.\u0275fac=function(s){return new(s||i)};static#e=this.\u0275mod=t.oAB({type:i});static#a=this.\u0275inj=t.cJS({imports:[T.ez,tt,b.X]})}return i})(),at=(()=>{class i{static#t=this.\u0275fac=function(s){return new(s||i)};static#e=this.\u0275mod=t.oAB({type:i});static#a=this.\u0275inj=t.cJS({imports:[T.ez,X,K.O,Z.ZX,b.X,y.Tx,A.Ps,V.q,et]})}return i})()}}]);